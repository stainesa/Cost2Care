---
title: "Predictions_Outcomes_ranger.Rmd"
author: "Anthony Staines"
date: "`r Sys.Date()`"
output: html_document
---

```{r clean up environment}
rm(list = ls())
```


# Intent

Our aim is to develop models for prediction of the various adverse outcomes, pneumonia, UTI, delirium and pressure ulcer from HIPE data. There are two HIPE data sets, one for all the HIPE data (H.N) and one for HIPE data from the chart review site (H.S). The gold standard for complications these is the chart review data (CTC.H).

The most obvious limitation is that the chart review was done in one hospital, a model 4 centre. The national HIPE data used here has only Model 3 and Model 4 hospitals.

# Predictions

Prepares predictions for each of our outcomes using a tree-based (ranger) classification approach, for the study site file, using the study (chart review) outcomes, and the HIPE predictors. These are then applied to the national data to see how they perform.

```{r setup, include=FALSE}
rm(list=ls())

library(tidyverse)
library(lubridate)
library(tibble)
library(readxl)
library(comorbidity)
library(tidymodels)
library(lme4)
#library(lmerTest)
library(knitr)
library(kableExtra)
library(summarytools)
library(patchwork)


library(ranger)
library(mlr3verse)
library(mlr3viz)
library(data.table)
library(future)

library(sjPlot)
library(sjtable2df)

library(broom)
library(broom.mixed)

library(stargazer)

tidymodels_prefer(quiet = TRUE)

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = NA, message = NA, fig.pos = 'H',
      cache.extra = knitr::rand_seed)

st_options(ctable.round.digits = 2)

#How many CPU's?
N = 16
  options(Ncpus = N - 1)
  options(mc.cores = N - 1)
  setDTthreads(threads = N - 1,
               restore_after_fork = TRUE,
               throttle = 1024)

options(dplyr.summarise.inform = FALSE, # shut up summarise
        ranger.num.threads = N) # Prepare for rf models
lgr::get_logger("mlr3")$set_threshold("error")
lgr::get_logger("bbotk")$set_threshold("error")


set.seed(979)
rm(N)
```

## Load the merged data file, and the national file
These are the chart review file merged with the matched HIPE file provided by HPO, and the national HIPE file. They have been extensively processed.

```{r Load data file}

#####################################################
# Load the Names
# 
NAMES <- read_excel(
      'data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx',
      sheet = 'NAMES')

#####################################################
# Load the merged HIPE/Study data file
# 
CTC.H <- readRDS('data/transformed_data/CTC.H.Rds')

#####################################################
# Load the total national HIPE data file
# 
H.N <- readRDS('data/transformed_data/H.N.Rds')

```

## Tidy data

```{r Remove non-HIPE codes, except for outcomes, and duplicate codes}
    CTC.H <- CTC.H %>%
    select(-c("discode","source", "Ward_moves", "Bed_moves"))
```


```{r test of selecting columns}
##################################################################
# This function allows us to replace a given outcome (PN etc...)
#  with the generic variable Outcome. Hence we can model Outcome
#  without worrying about which Outcome we've got
#
Set_Outcome <- function(Outcome = PN, df = CTC.H ) {
    df |>
        mutate(Outcome = {{Outcome}})
}

# Check
Df <- Set_Outcome(PN,CTC.H)
    table(Df$PN,Df$Outcome)
Df <- Set_Outcome(UTI,CTC.H)
    table(Df$UTI,Df$Outcome)
Df <- Set_Outcome(PU,CTC.H)
    table(Df$PU,Df$Outcome)
Df <- Set_Outcome(DL,CTC.H)
    table(Df$DL,Df$Outcome)
Df <- Set_Outcome(F2M,CTC.H)
    table(Df$F2M,Df$Outcome)
```

```{r}
#################################################
# Define a classification task for PN
#
tsk_PN <- as_task_classif(CTC.H,
                          target = "PN",
                          id = 'PN')
  tsk_PN
  
  split_PN = mlr3::partition(tsk_PN)
  split_PN
  
  autoplot(tsk_PN) + 
    labs (title = 'Pneumonia',
          x = 'PN',
          y = 'Coding in chart review')
```

