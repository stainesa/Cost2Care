---
title: "Cost2Care Data load and transform"
author: "Anthony Staines"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    fig_caption: true
    number_sections: true
    latex_engine: xelatex
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
bibliography: references.bib
csl: vancouver.csl
---

```{r setup, include=FALSE}
rm(list=ls())

library(tidyverse)
library(readxl)
library(knitr)
library(kableExtra)

library(rsample)
library(comorbidity)

library(skimr)
library(summarytools)

knitr::opts_chunk$set(echo = FALSE, cache = TRUE,
                      warning = NA, message = NA,
                      fig.pos = 'H',
                      cache.extra = knitr::rand_seed)
#How many CPUs?
N = parallel:::detectCores()

options(Ncpus = N)
options(mc.cores = N)
options(dplyr.summarise.inform = FALSE, # shut up summarise
        ranger.num.threads = N) # Prepare for rf models

#lgr::get_logger("mlr3")$set_threshold("error")
#lgr::get_logger("bbotk")$set_threshold("error")

set.seed(979)
rm(N)
```

# Aims

This file loads the main HIPE data, and the HIPE data for the study hospital, a Model 4 hospital, the chart review data for the study hospital, and a file of the ACHI procedure codes used nationally in that year. It processes these data, and prepares the analysis datasets, including the simplified dataset used in the final analyses.

# Load and process the national HIPE, ACHI, site HIPE, and Chart Review data files

First we load the data.

```{r Load main data files, results = 'hide'}
########### Main HIPE file #####################
HIPE <- as_tibble(read.csv("data/H240272_2022.csv",
        strip.white = TRUE, na.strings = c("", NA)))

########### StudyID ##################################
#There is a StudyID variable at the start of the HIPE site file, so we add a blank StudyID to the start of this HIPE file
#
HIPE <- HIPE %>%
  mutate(StudyID = paste0(row_number())) %>%
  relocate(StudyID) # To first column

########### HIPE.Site #################################
# HIPE linked to chart review file
# 
HIPE.Site <- as_tibble(
  read.csv("data/H240272_2022_Site_Study_Subjects.csv", strip.white = TRUE, na.strings = c("", NA)))
# 
# Lose two rows in HIPE.Site - StudyID's 41 and 405
# These never had a chart review.
# 
HIPE.Site <- HIPE.Site %>%
  filter(StudyID != 41 & StudyID != 405)
glimpse(HIPE.Site)

########## Make StudyID character ###################
# Make StudyID a character variable
# 
HIPE.Site <- HIPE.Site %>%
  mutate(StudyID = as.character(StudyID))

########### Sheet names ################################
# Check the sheet names (Note the extra ' ' (space) in the "Chart review data ")
# 
excel_sheets('data/Final Cleaned Data Cost2Care Chart Review and HIPE Data 17th February 2025 WORKING.xlsx')
# 
# StudyID's 41 and 405 never had a chart review, and are not in this file.
# 
Cost2Care <- read_excel(path='data/Final Cleaned Data Cost2Care Chart Review and HIPE Data 17th February 2025 WORKING.xlsx',
                        sheet = 'Chart review data ',
                        range = "A2:FX1002")

########### Fix the names ##########################
# Fix the names
#  set better names up manually, and load.
# PN - PNeumonia;       UTI - Urinary Tract Infection;
# PU - Pressure Ulcer;  DL - DeLirium
# 
    NAMES <- read_excel(
      'data/Final Cleaned Data Cost2Care Chart Review and HIPE Data 17th February 2025 WORKING.xlsx',
      sheet = 'NAMES')
    names(Cost2Care) <- NAMES$Chart_review_data_revised

########### Remove unnamed columns ###################
# Remove 5 empty columns with missing names
# 
Cost2Care <- Cost2Care %>%
  select(-c(which(is.na(names(Cost2Care)))))

########## Make StudyID character ###################
# Make StudyID a character variable
#
Cost2Care <- Cost2Care %>%
  mutate(StudyID = as.character(StudyID))
          
########### Read ACHI file #############################
# ACHI file
# 
excel_sheets('data/H240272_Proc_ACHI_MAP_10thEdn.xlsx')

ACHI <- as_tibble(
  read_excel('data/H240272_Proc_ACHI_MAP_10thEdn.xlsx',
             sheet = 'Proc_ACHI_MAP_10thEdn'))
```

## Process the HIPE and coding data

We now have the four original data files loaded, and minimally tidied.
We now do a *lot* more preparation on the national and site HIPE data files.

### HIPE processing

We write a function that

* Names the variables consistently
* Generates a number of new variables
    + ID, a unique identifier variable
    + DateOfAdmission, DateOfDischarge, MonthOfAdmission, MonthOfDischarge
    + SeasonOfAdmission (Nov-Feb = Winter) (Mar-Oct = Other)
    + MedSurg, based on recorded speciality on admission
    + ModelF, a factor for Hospital Model
    + HospNo and HospCode
    + Source - four levels each, Home, Care, Transfer, Other
    + Destination - four levels each, Home, Care, Transfer, Dead, Other
    + Died - Dead or Alive
    + Charlson and Elixhauser scores and components
    + ProcCount, HadxCount, and DxCount - counts of non-missing codes
    + AgeC and LosC - centred and scaled Age (age) and Length of stay (rawlos)
  
```{r Function <HIPE_PROCESS> to process both HIPE files}
HIPE_PROCESS <- function (HIPE_FILE) {
############# Tidy names ####################
# tidy up the names in the files provided
# 
  names(HIPE_FILE)
    names(HIPE_FILE) <- str_to_lower(names(HIPE_FILE)) # All lower case
    names(HIPE_FILE) <- str_replace_all(names(HIPE_FILE), "_", ".") # no _, use . instead
    names(HIPE_FILE) <- str_replace(names(HIPE_FILE), "(\\d*$)", ".\\1") # A dot place before any digits at the end, otherwise at the end
    names(HIPE_FILE) <- str_replace(names(HIPE_FILE), "(\\.$)", "") # Remove unwanted dots at the end, those not followed by digits.

############# ID variable ###################
# Set up an ID variable
#   
HIPE_FILE <- HIPE_FILE %>%
  mutate(rowid_to_column(., var = "ID")) %>% # Numeric ID
  mutate(ID = paste0("ID.",ID, sep = '')) # Character ID

############# Time variables ################
# Calculate some time related variables
# 
HIPE_FILE <- HIPE_FILE %>%
  mutate(DateOfAdmission = paste0('15',mon.adm)) %>% # Process dates in MY format correctly, set day to 15th of each month
  mutate(DateOfAdmission = dmy(DateOfAdmission)) %>%
  mutate(DateOfDischarge = (DateOfAdmission + rawlos)) %>% # Crude estimate of date of discharge, but all we want is winter/not_winter
  mutate(MonthOfAdmission = lubridate::month(DateOfAdmission, label=TRUE)) %>%
  mutate(MonthOfDischarge = lubridate::month(DateOfDischarge, label=TRUE)) %>%
  mutate(SeasonOfAdmission =
           case_match(as.character(MonthOfAdmission),
                      c("Nov","Dec","Jan", "Feb") ~ "Winter",
c("Mar","Apr","May","Jun","Jul","Aug","Sep","Oct") ~ "Other"
                                    ))
#return(HIPE_FILE)
#}
############# Med/Surg ######################
# Prepare a Medical/Surgical Group variable
# REPLACE WHEN PROCEDURE CODES FOR ANAESTHETICS AVAILABLE!!
HIPE_FILE <- HIPE_FILE %>%
      mutate(MedSurg = 
                case_match(specialty,
"Accident & Emergency" ~ "Medical",
"Cardiology" ~ "Medical",
"Clinical (Medical) Genetics" ~ "Medical",
"Dermatology" ~ "Medical",
"Diabetes Mellitus" ~ "Medical",
"Endocrinology" ~ "Medical",
"Gastro-Enterology" ~ "Medical",
"General Medicine" ~ "Medical",
"Genito-Urinary Medicine" ~ "Medical",
"Geriatric-Medicine" ~ "Medical",
"Haematology" ~ "Medical",
"Histopathology" ~ "Medical",
"Infectious Diseases" ~ "Medical",
"Intensive Care" ~ "Medical",
"Microbiology" ~ "Medical",
"Nephrology" ~ "Medical",
"Neurology" ~ "Medical",
"Neuroradiology" ~ "Medical",
"Oncology" ~ "Medical",
"Paediatric Oncology" ~ "Medical",
"Paediatrics" ~ "Medical",
"Pain Relief" ~ "Medical",
"Palliative Medicine" ~ "Medical",
"Psychiatry" ~ "Medical",
"Radiology" ~ "Medical",
"Radiotherapy" ~ "Medical",
"Respiratory Medicine" ~ "Medical",
"Rheumatology" ~ "Medical",
"Anaesthetics" ~ "Surgical",
"Breast Surgery" ~ "Surgical",
"Cardio-Thoracic Surgery" ~ "Surgical",
"Dental Surgery" ~ "Surgical",
"Gastro-Intestinal Surgery" ~ "Surgical",
"General Surgery" ~ "Surgical",
"Gynaecology" ~ "Surgical",
"Hepato-Biliary Surgery" ~ "Surgical",
"Maxillo-Facial" ~ "Surgical",
"Neurosurgery" ~ "Surgical",
"Obstetrics" ~ "Surgical",
"Obstetrics/Gynaecology" ~ "Surgical",
"Ophthalmology" ~ "Surgical",
"Orthopaedics" ~ "Surgical",
"Otolaryngology (ENT)" ~ "Surgical",
"Plastic Surgery" ~ "Surgical",
"Renal Transplantation" ~ "Surgical",
"Urology" ~ "Surgical",
"Vascular Surgery" ~ "Surgical"))
             
############# Training split 1:4 ############
# Then we split into training and test datasets
# 
HIPE_FILE_split <- initial_split(HIPE_FILE, prop = 4/5, strata = hosp.anon)

# Add a training variable to the dataframe

HIPE_FILE <- HIPE_FILE %>%
  mutate(Training = FALSE)

# Add a variable to indicate training set or test set.
 HIPE_FILE$Training[HIPE_FILE_split$in_id] <- TRUE

############# Hospital model codes ##########
# Add Hospital Model codes
HIPE_FILE <- HIPE_FILE %>%
    # Now we reorder the group
    mutate(MODELX = as_factor(model)) %>%
    mutate(ModelF = fct_relevel(
        MODELX,
        c("Model 4", "Model 3", "Model 2", "Specialist", "Maternity" ),
        after = Inf)) %>%
    select (-MODELX) %>%
    # now we identify the group
    mutate(ModelCode = case_match(model,
        'Model 4' ~ '4',
        'Model 3' ~ '3',
        'Model 2' ~ '2',
        'Specialist' ~ 'S',
        'Maternity' ~ 'M'
    ))

###################################
# Missing vales in HIPE file
# There are a set of variables in the HIPE file :
#  uti, delirium, pressure.ulcer, pneumonia, uti.hadx, delirium.hadx, pressure.ulcer.hadx, pneumonia.hadx, any.F2M, any.F2M.hadx
#  
#  These cause problems in regression because
#  they are largely missing, with a few 1's.
#  We need to convert them into
#  non-missing variables 0 and 1.
# Fix hadx variables in HIPE}

HIPE_FILE <- HIPE_FILE |>
  mutate(across(uti:any.f2m.hadx,
                ~ ifelse(is.na(.),0,1)))

############# Hospital codes ################
# Make short per hospital codes
CODES <- HIPE_FILE %>%
    select(ModelCode, hosp.anon) %>%
    group_by(ModelCode) %>% 
    arrange(ModelCode, hosp.anon) %>%
    distinct() %>%
    mutate(HospNo = row_number()) %>%
    mutate(HospCode = paste0(ModelCode, '.', HospNo)) %>%
    mutate(HospCode = fct_inorder(HospCode))

# Merge the short codes back into the main dataset

HIPE_FILE <- HIPE_FILE %>%
    left_join(CODES, by = join_by(hosp.anon, ModelCode))

############# Source and Destination ########
# Sensibly code Source and Destination
# 
# 
HIPE_FILE <- HIPE_FILE %>%
    mutate(Source = case_match(source,
                            c(1,8,9) ~ "Home",
                            2 ~ "Care",
                            c(0,3,4,5,6,7) ~ "Transfer")) %>%
    mutate(Died = case_match(discode,
                            c(6,7) ~ "Dead",
                            c(0,1,2,3,4,5,
                              8,9,10,11,
                              12,13,14,15) ~ "Alive")) %>%
    mutate(Destination = case_match(discode,
                            1 ~ "Home",
                            c(2,11) ~ "Care", # includes hospice
                            c(3,4,5,8,9,10) ~ "Transfer",
                            c(6,7) ~ "Dead",
                            c(0,12,13,14,15) ~ "Other"))

############# E & C Scores ##################
# Scoring - Calculate Elixhauser and Charlson codes
# 
HIPE_FILE <- HIPE_FILE %>%
  unite(col = "ICD_combined",
        dx.01:dx.30, sep=' ',
        remove = FALSE, na.rm=TRUE) # comorbidity expects a single variable containing all the ICD10 codes to be used as a string, hence ICD-combined - This is a *BAD* idea.

################# Charlson ##################
# Charlson
charlson <- comorbidity(x = HIPE_FILE, id = "ID", code = "ICD_combined", map = "charlson_icd10_am", assign0 = FALSE)
    charlson <- charlson %>% 
      mutate(score = score(charlson, weights='quan', assign0 = TRUE))
        names(charlson)[-1] <- paste0(str_to_title(names(charlson)[-1]),
                                      'Ch', sep='')

################# Elixhauser ################
# Elixhauser
elixhauser <- comorbidity(x = HIPE_FILE, id = "ID", code = "ICD_combined", map = "elixhauser_icd10_quan", assign0 = FALSE)
    elixhauser <- elixhauser %>% 
      mutate(score = score(elixhauser, weights='swiss', assign0 = TRUE))
        names(elixhauser)[-1] <- paste0(str_to_title(names(elixhauser)[-1]),
                                        'El', sep='')

############# Add scores back ###############
# Put the scores back in the main file
HIPE_FILE <- HIPE_FILE %>%
  left_join(charlson, by = join_by(ID), suffix = c("", ".ch")) %>%
  left_join(elixhauser, by = join_by(ID),suffix = c("", ".el"))

############# Counts ########################
# Add a count of procedures, diagnoses and hadx scores
# 
HIPE_FILE <- HIPE_FILE %>%
  mutate(ProcCount = purrr::pmap_dbl(HIPE_FILE %>% select(proc.01:proc.20),
                           ~sum(!is.na(c(...))))) %>%
  mutate(DxCount = purrr::pmap_dbl(HIPE_FILE %>% select(dx.01:dx.30),
                           ~sum(!is.na(c(...))))) %>%
  mutate(HadxCount = purrr::pmap_dbl(HIPE_FILE %>% select(hadx.01:hadx.30),
                           ~sum(!is.na(c(...)))))
 
############# Centre and scale ##############
# Centre and scale age, rawlos and other numeric variables
# 
HIPE_FILE <- HIPE_FILE %>%
  mutate(AgeC = as.vector(scale(age))) %>%
  mutate(LosC = as.vector(scale(rawlos)))

#
## scale produces a matrix output
#

############# Select and order ##############
# Select and order the desired variables
# This will *change* if more calculated variables are added
#
HIPE_FILE <- HIPE_FILE %>%
  mutate(StudyID = studyid) %>% #Capitalise this again
  select(StudyID, ID, Training, ModelF, ModelCode, HospCode, MedSurg,
         AgeC, LosC,
         DateOfAdmission, MonthOfAdmission, SeasonOfAdmission,
         DateOfDischarge, MonthOfDischarge,
         ScoreEl, ScoreCh, ends_with('El'), ends_with('Ch'),
         HospNo:Destination, ProcCount:HadxCount,
         hosp.anon:proc.desc.20) # Reorder variables

############# Return ##########################
# Finish, returning a single tibble
#
    return(HIPE_FILE)
}

```

### Apply key function to HIPE data

There are two HIPE data files.

* HIPE.Site contains HIPE data matched to the specific records reviewed as part of the chart review.
* HIPE contains the national HIPE data for the same population.

Note that the HIPE file *includes* the whole HIPE.Site data, but they are not matched, nor linked by any common identifier.

```{r Process both files HIPE and HIPE.Site}

HIPE <- HIPE_PROCESS(HIPE)
HIPE.Site <- HIPE_PROCESS(HIPE.Site)

```

## DRG

DRG codes are alphanumeric codes, which have a description attached. Most of these descriptions, include an indication of complexity, either Minor, Intermediate or Major.

### DRG codes

```{r DRG descriptions without Complexity clearly marked}
DRG_used <- HIPE |>
  select(drgv.8,drg.desc) |>
  group_by(drgv.8, drg.desc) |>
  summarise(N = n()) |>
  arrange(desc(N))

DRG_noComplexity <- DRG_used |>
  filter(!grepl('omplexity',drg.desc)) |>
  group_by(drgv.8, drg.desc) |>
  summarise(N = n()) |>
  arrange(desc(N))

DRG_noComplexity_at_all <- DRG_used |>
  filter(!grepl('omp',drg.desc)) |>
  group_by(drgv.8, drg.desc) |>
  summarise(N = n()) |>
  arrange(desc(N))
```

In some `r length(DRG_noComplexity$N)` out of `r length(DRG_used$N)`, the complexity description is abbreviated to Comp, or to Inter comp, Min Comp, or it is missing altogether.

```{r Cleanup Nocomplexity}
rm(DRG_noComplexity_at_all, DRG_noComplexity, DRG_used)
```

Looking at the history of the DRG codes [1. Dimitropoulos V, Yeend T, Zhou Q, McAlister S, Navakatikyan M, Hoyle P, et al. A new clinical complexity model for the Australian Refined Diagnosis Related Groups. Health Policy. 2019 Nov 1;123(11):1049â€“52.], of those in this study, five clearly are (at least) intermediate complexity DRG's, requiring transfer within 5 days, which ought to be reflected in our analysis.

Note that these are not given complexity codes in the DRG system, because the purpose of that system was to predict costs. It is also worth noting that patients who were rapidly transferred will mostly be in the study as transfers from another facility, and will have little opportunity to have our outcomes recorded in the originating hospital. These codes were -

* Intermediate
  + B70D (39) Stroke and Other Cerebrovascular Disorders, Transferred to Acute Facility <5 Days
  + B78C (7) Intracranial Injuries, Transferred to Acute Facility <5 Days
  + F60B (72) Circulatory Disorders, Admitted for Acute Myocardial Infarction without Invasive Cardiac Investigative Procedures, Transferred to Acute Facility <5 Days
  + F62C (20) Heart Failure and Shock, Transferred to Acute Facility <5Days
  + Y60Z (3) Burns, Transferred to Acute Facility <5 Days

In addition, a number of codes represent significantly complex conditions, and, for our purposes, ought to be further coded for complexity. These include

* Intermediate
  + T40Z (9) Infectious and parasitic diseases with ventilator support
* High
  + A01Z (4) Liver transplant
  + A03Z (4) Heart and/or lung transplant
  + W03Z (2) Abdominal Procedures for Multiple Significant Trauma
  + Y01Z (2) Vent >=96hrs or Trach for Burns or OR Procs for Severe Full Thickness Burns

### DRG processing

We prepare a coding file to put DRG's into levels of complexity, as discussed below.

```{r code DRGs as complexity}
#
## Generate a tibble with two columns - DRG code and complexity
#
DRG <- HIPE |>
  select(drgv.8, drg.desc) |>
  group_by(drgv.8, drg.desc) |>
  summarise(N = n()) |>
  arrange(desc(N))

DRG <- DRG |>
  mutate(Complexity = ifelse(
    str_detect(stringi::stri_extract_last_words(drg.desc), pattern = 'omp'),
    word(drg.desc, -2),'NOCOMP')) %>%
  # Take the second last word in the description,
  # but only if the last word matches 'omp'. This is beacuse Complexity
  # ia abbreviated as Comp in these data
  mutate(Complexity = case_match(Complexity,
                                 c("Min", "Minor") ~ "Minor",
                                 c("Interm", "Intermediate") ~ "Intermediate",
                                 c("Maj", "Major") ~ "Major",
                                 c("NOCOMP") ~ "NOCOMP"
                                 )) %>%
  # Recode complexity to map the abbreviations Min, Maj and Interm to the
  # respective full values, and flag descriptions where
  # no specific complexity given as NOCOMP
  mutate(CC = case_match(drgv.8,
                        c('B70D','B78C','F60B','F62C','Y60Z') ~ 'Intermediate',
                        c('T40Z') ~ 'Intermediate',
                        c('A01Z','A03Z','W03Z','Y01Z') ~ 'Major',
                        .default = 'NOCOMP'
                        )) %>%
  # Recode the specific identified DRG codes discussed in the text correctly
  mutate(Complexity = ifelse(Complexity == 'NOCOMP', CC, Complexity)) %>%
  mutate(Complexity = ifelse(Complexity == 'NOCOMP', 'Minor', Complexity)) %>%
  # Add these specific codes to the main list
  # and set all others to Minor in two stages
  mutate(Complexity = as_factor(Complexity)) %>%
  mutate(Complexity = fct_relevel(Complexity, "Minor", "Intermediate", "Major"))
  # Make Complexity a factor in the correct order

DRG_coding <- DRG %>%
  # Lose the extra variables from DRG
  select(drgv.8, Complexity)

DRG <- DRG |> group_by(Complexity) |> summarise(Count = sum(N))

```

We use this file to add the DRG Complexity codes to the files HIPE and HIPE.Site

```{r Add DRG complexity codes to the two files}

HIPE <- HIPE |>
  left_join(DRG_coding, by = join_by(drgv.8 == drgv.8)) |>
  select(StudyID:HadxCount, Complexity, hosp.anon:proc.desc.20)

HIPE.Site <- HIPE.Site |>
  left_join(DRG_coding, by = join_by(drgv.8 == drgv.8)) |>
  select(StudyID:HadxCount, Complexity, hosp.anon:proc.desc.20)

```

### Level of complexity

High complexity is the commonest, but intermediate and low complexity together are a small majority of admissions.

```{r Table of complexity}

kable(DRG)

```

## ACHI Procedures codes

For the diagnoses, there are two sets of summary codes already provided. These are DRG codes and MDC codes, which provide, respectively, a longer and shorter summary of the diagnosis assigned. For procedures no simple classification is accessible. Each person has up to 30 codes, and the only guide is the the first procedure is that associated with the reason for admission. After that, many of the procedure codes are blank, as most people have less than 3 procedure codes.

### Intent of processing procedure codes

We have two goals - 

* Identify people who had anaesthetics, often used as a proxy for surgical cases.
* Reduce the number of procedure codes to a manageable number for further analysis.

To do this we have access to the following for each of the procedures used in the data -

* proc - One of 2,469 numeric procedure codes
* proc_desc - A description of what each code covers
* Block -  One of 942 numeric codes for an aggregate of related procedure codes
* block_desc - A description of each block
* Proc_Type - One of 81 general descriptions of the type of procedure
* Anatomical_Site - One of 119 body sites where that procedure was done
* Chapter_n - One of 19 codes for the ACHI chapter into which that procedure falls
* Chapter - A description of each chapter

```{r skim ACHI}
skim(ACHI %>%
       mutate( across( where(is.numeric) , as.character)))
        # Make all variables characters temporarily
```

### Add ACHI codes to the main dataset.

First, prepare files with one row per procedure per discharge (20 rows per discharge record).

Then compare the list of ACHI codes provided to that in the full HIPE, and the chart review site HIPE data.

All codes go from 0 - no procedure in that category, up to the total number of procedures received in that category

There are 19 chapters, most of which make sense, but one, Chapter 19, 'Interventions Not Elsewhere Classified' needs to be divided further. In any event each chapter needs to become a variable. Chapter 19 can be divided sensibly further into the 'anatomical site' recorded, as these are things like 'Diagnostic test', and 'Allied Health Professional'.

### ACHI processing

We prepare a coding file to group ACHI procedures into meaningful groups, mostly by ACHI chapter, for Intervention n.e.c. we use the Anatomical sites provided.

```{r Prepare per procedure files PROC and PROC_SITE}
# These have 20 rows per StudyId, one of each of the 20 procedure codes.

PROC <- HIPE |>
  select(StudyID,proc.01:proc.20) |>
  pivot_longer(cols=!StudyID,
               names_to = 'Procedure',
               values_to = 'ACHI_code') |>
  full_join(ACHI, by = join_by(ACHI_code == proc))


PROC.Site <- HIPE.Site |>
  select(StudyID, proc.01:proc.20) |>
  pivot_longer(cols=!StudyID,
               names_to = 'Procedure',
               values_to = 'ACHI_code') |>
  full_join(ACHI, by = join_by(ACHI_code == proc)) |>
  filter(!is.na(StudyID)) # Remove unused codes

```

Check the codes used

```{r compare list of ACHI codes provided to that in the full HIPE (not the chart review site HIPE.site) file}

    PROC_unused <- PROC |> filter(is.na(StudyID)) |> select(ACHI_code) |>
      group_by(ACHI_code) |> unique() |>
      arrange(ACHI_code) # 0 codes not used

    PROC_used <- PROC |> filter(!is.na(StudyID)) |> select(ACHI_code) |>
      group_by(ACHI_code) |> unique() |>
      arrange(ACHI_code) # 2470 codes used
# Total codes is 2470 - the original 2469 and the missing code

   PROC_unused.Site <- PROC.Site |> filter(is.na(StudyID)) |> select(ACHI_code) |>
      group_by(ACHI_code) |> unique() |>
      arrange(ACHI_code) # 1995 codes not used

    PROC_used.Site <- PROC.Site |> filter(!is.na(StudyID)) |> select(ACHI_code) |>
      group_by(ACHI_code) |> unique() |>
      arrange(ACHI_code) # 475 codes used
# Total codes is 2470 - the original 2469 and the missing code

rm(PROC_unused, PROC_unused.Site, PROC_used, PROC_used.Site)
```

Create the coding variable

```{r Add GROUP variable}
# Each chapter is one group, except Chapter 19, 
# which is divided by Anatomical site.
#
###########################################
# Group procedures for HIPE file
PROC <- PROC |>
  mutate(GROUP = ifelse(Chapter_n == 19,
                        Anatomical_Site,
                        Chapter)) %>%
  mutate(GROUP = ifelse(Anatomical_Site == 'Anaesthesia And Analgesia',
                        Proc_Type, # 'Anaesthesia' or 'Analgesia'
                        GROUP)) %>%
  mutate(value = ifelse(is.na(GROUP),
                        0, 1)) %>% # 1 means that Group was present.
  mutate(GROUP = ifelse(is.na(GROUP),'blank', GROUP)) # Replace all missing values with blank, which allows us to remove these later

###########################################
# Now make each GROUP a separate variable
# using summarise to get the count, and pivot_wider to get the desired form
PROC <- PROC |>
  group_by(StudyID, GROUP, value) |>
  summarise(Count = sum(value)) |> # Add up the count of procedures
  ungroup() |>
  pivot_wider(id_cols=StudyID,
              names_from = GROUP, values_from = Count,
              values_fill = 0) |> #no missing values
  select(-blank) |> # Remove columns of zeros
  arrange(as.numeric(StudyID))

#Tidy up the names
#
names(PROC) = str_squish(names(PROC)) # Remove spaces at beginning and end, and collpase others into one space
names(PROC) = str_replace_all(names(PROC),' ','.') # Replace space with .
names(PROC) = str_replace_all(names(PROC),',','') # Replace , with nothing

###########################################
# Group procedures for HIPE.Site file
PROC.Site <- PROC.Site |>
  mutate(GROUP = ifelse(Chapter_n == 19,
                        Anatomical_Site,
                        Chapter)) %>%
  mutate(GROUP = ifelse(Anatomical_Site == 'Anaesthesia And Analgesia',
                        Proc_Type, # 'Anaesthesia' or 'Analgesia'
                        GROUP)) %>%
  mutate(value = ifelse(is.na(GROUP),
                        0, 1)) %>% # 1 means that Group was present.
  mutate(GROUP = ifelse(is.na(GROUP),'blank', GROUP))

###########################################
# Now make each GROUP a separate variable
PROC.Site <- PROC.Site |>
  group_by(StudyID, GROUP, value) |>
  summarise(Count = sum(value)) |> # Add up the count of procedures
  ungroup() |>
  pivot_wider(id_cols=StudyID,
              names_from = GROUP, values_from = Count,
              values_fill = 0) |> #no missing values
  select(-blank) |> # Remove columns of zeros
  arrange(as.numeric(StudyID))

#Tidy up the names
#
names(PROC.Site) = str_squish(names(PROC.Site)) # Remove spaces at beginning and end, and collpase others into one space
names(PROC.Site) = str_replace_all(names(PROC.Site),' ','.') # Replace space with .
names(PROC.Site) = str_replace_all(names(PROC.Site),',','') # Replace , with nothing

# There are two sets of Procedures which do not occur in the study hospital
# Procedures.On.Ear.And.Mastoid.Process
# and
# Client.Support.Interventions
# For sanity we add both, set to zero.
# 
PROC.Site <- PROC.Site %>%
  mutate(Procedures.On.Ear.And.Mastoid.Process = 0) %>%
  mutate(Client.Support.Interventions = 0)

############ Order columns ################################
#
# Order the columns in the two dataframes PROC and PROC.Site the same way
#
PROC <- PROC %>%
  select(order(colnames(PROC))) %>%
  relocate(StudyID)

PROC.Site <- PROC.Site %>%
  select(order(colnames(PROC.Site))) %>%
  relocate(StudyID)


```

Merge these ACHI codes into both datasets

```{r Merge the group variables back into the two main datasets}
#####################################
# HIPE
# 
HIPE <- HIPE |>
  full_join(PROC, by = join_by(StudyID == StudyID)) |>
  select(StudyID:Complexity,
         Anaesthesia:Therapeutic.Interventions,
         hosp.anon:proc.desc.20)

#####################################
# HIPE.Site
# 
HIPE.Site <- HIPE.Site |>
  full_join(PROC.Site, by = join_by(StudyID == StudyID)) |>
  select(StudyID:Complexity,
         Anaesthesia:Therapeutic.Interventions,
                  hosp.anon:proc.desc.20)
```

## Merge the HIPE.Site data and the chart review data

Next we check and merge the Chart Review data, and the corresponding HIPE.Site data for those cases. These are from a selected weighted sample of discharges for people aged 65 and over from *one* large Model 4 hospital.

```{r Check and merge two sets of site data}

################# Check Names/StudyID's ###############
# 
COMBINED <- full_join(
  Cost2Care %>%
    select(StudyID, Encrypted_mrn),
  HIPE.Site %>%
    select(StudyID, ID),
      by = join_by(StudyID)) # check for missing study IDS

################# Join files  #######################
# Join the main files
# 
Cost2Care.HIPE <- full_join(
    Cost2Care,
    HIPE.Site,
    by = join_by(StudyID))

################# Check for duplicate names #########
# Duplicate names - fixed in Cost2Care working spreadsheet sheet NAMES
# 'data/Final Cleaned Data Cost2Care Chart Review and HIPE Data 17th February 2025 WORKING.xlsx'
# 
NN <- names(Cost2Care.HIPE)
NN[c(which(str_detect(NN, "\\.y|\\.x")))] # Should be PN.xray only
rm(COMBINED, NAMES, NN)
```

## Failure to maintain

This is a variable indicating the presence of one, or more, of PN (Pneumonia), UTI (Urinary tract infection), PU (Pressure ulcer), or DL (Delirium) associated with health care identified in the chart review.

This adds one new variable to the combined Hipe.Site and Chart Review file

* F2M Failure to maintain

```{r Failure to Maintain F2M}  
############# F2M ############################
# F2M Failure to maintain - any one or more of the adverse outcomes
# PN (Pneumonia), UTI (Urinary tract infection), PU (Pressure ulcer), or DL (Delirium)

Cost2Care.HIPE <- Cost2Care.HIPE |>
    mutate(F2M = ifelse(
        (UTI == "Yes" | PN == "Yes" | PU == "Yes" | DL == "Yes")
        ,"Yes", "No")
    )
```

## Summary report

```{r Calculate some useful numbers}
# some relevant figures
  PEOPLE <- nrow(HIPE)
  HOSPITALS <- length(unique(HIPE$hosp.anon))
  STUDY <- nrow(HIPE.Site)

```

There are a total of `r PEOPLE` admissions in these records, from `r HOSPITALS` different hospitals. Of these `r STUDY` from one Model 4 hospital took part in the chart review study.

```{r Delete the numbers}
rm(PEOPLE, HOSPITALS, STUDY)

```

# Outcomes

## Counts of admissions

How many discharges are included in these data? There are five types of hospital included, of very varying sizes. A simple table shows substantial variability in these.

```{r discharges table by site}
table(HIPE$ModelF)[[3]]

ctable(x = HIPE$HospCode,
       y = HIPE$ModelF,
       prop ='n')
```


```{r Discharges by hospital and hospital type, fig.cap= 'Discharges by hospital model and site.', fig.dpi=1200, fig.height=5, fig.width=7}
Discharge <- HIPE %>%
  select(ModelF, HospCode) %>%
  group_by(ModelF, HospCode) %>%
  summarise(N = n())

ggplot(data=Discharge,
       aes(x=HospCode, y = N, colour = ModelF, fill = ModelF)) +
           geom_col(colour = 'black') +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
    facet_wrap(~ModelF, scales = 'free_x') +
           labs( title = 'Number of discharges by hospital model and site)',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Hospital code',
                 y = 'Number of discharges') +
  guides(colour = "none", fill = "none", size = "none") +
    theme_minimal(base_size = 12)

rm(Discharge)
```

## Timing of admissions

Although some of the admissions were a very long time before discharge, most occurred during late 2021 and  2022, as Figure 1 shows.

```{r Admission dates by time, fig.cap= 'Admission dates by month and year for discharges included in the analysis.', fig.dpi=600, fig.height=4, fig.width=6}
Admissions <- HIPE %>%
    group_by(DateOfAdmission) %>%
    summarise(N = n())

ggplot(data=Admissions,
       aes(x=DateOfAdmission, y= N)) +
           geom_point(colour = 'red',
                      size = 3) +
    scale_x_date(date_breaks = '6 months',
                 date_labels = '%b_%y') +
           labs( title = 'Admissions per month in data set',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Date of admission',
                 y = 'Count') +
    theme_minimal(base_size = 12)
       
rm(Admissions)
```

## Comorbidity scores

It can be useful to consider comorbidity scores, and two of the most popular of these are the Elixhauser  and Charlson  scores. These are calculated using in this work using the comorbidity package , in turn based on.

The figure shows the joint and separate distributions of these scores amongst the discharges.  The very limited range of Charlson scores encountered, is contrasted with the much wider range of the Elixhauser scores.

```{r Plot of E & C scores, fig.cap= 'Plot of Elixhauser and Charlson weighted scores for the discharges included in the analysis.', fig.dpi=1200, fig.height=5, fig.width=7}
ggplot(data=HIPE,
       aes(x = ScoreCh, y = ScoreEl,
           fill = ModelCode, colour = ModelCode)) +
  geom_tile() +
  facet_wrap(~ModelCode) +
           labs( title = 'Plot of Elixhauser and Charlson weighted scores',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Charlson Score',
                 y = 'Elixhauser Score') +
  guides(colour = guide_legend("Hospital\nModel"),
         fill = guide_legend("Hospital\nModel")) +
    theme_minimal(base_size = 12)
```

## Length of stay

Lengths of stay varied greatly also, as Figure 2 shows. Model of hospital was one important source of variation, but between hospitals there is also evidence of considerable variation. In part, this is to be expected, given the differing roles of Model 4, Model 3, and Model 2 hospitals.

```{r Length of stay by hospital and hospital type, fig.cap= 'Length of stay (days) by hospital model and site (outliers excluded).', fig.dpi=1200, fig.height=5, fig.width=7}


ggplot(data=HIPE,
       aes(x=HospCode, y = rawlos, colour = ModelF)) +
           geom_boxplot(outliers = FALSE, varwidth = TRUE) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
    facet_wrap(~ModelF, scales = 'free') +
           labs( title = 'Length of stay in days by hospital model and site\n (outliers excluded)',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Hospital code',
                 y = 'Count') +
  guides(colour = "none", fill = "none", size = "none") +
  #guides(colour = guide_legend("Hospital\nModel"),
  #       fill = guide_legend("Hospital\nModel")) +
    theme_minimal(base_size = 12)

```

A table showing the median, and a range of quantiles for the length of stay is also helpful. This is presented in the same order as the items in Figure 2.

```{r LOS Table}

LOS <- HIPE %>%
    group_by(ModelF, HospCode) %>%
    summarise(Mean   = round(mean(rawlos, na.rm = TRUE),2),
              Q10    = quantile(rawlos, probs = 0.1),
              Q25    = quantile(rawlos, probs = 0.25),
              Median = quantile(rawlos, probs = 0.5),
              Q75    = quantile(rawlos, probs = 0.75),
              Q90    = quantile(rawlos, probs = 0.90)) %>%
    ungroup()

kbl(LOS,  booktabs = TRUE, longtable = TRUE,
    caption = "Length of Stay by Hospital Type and Site.")

rm(LOS)
```

Again there is substantial variation between and within hospital types.

## Deaths, and discharge outcomes

Another very important variable is deaths in hospital. While most patients are discharged alive (be that a return home, or a transfer to other care sites, including other acute hospitals), about 6% of those admitted, aged over 65, and staying for more than three days, did not survive.

The table gives the overall results, and the figure shows how this varied between hospitals, and hospital types

```{r Dead table}
Dead <- HIPE %>%
  group_by(Died) %>%
  summarise(N = n())

kbl(Dead,  booktabs = TRUE, longtable = FALSE,
    caption = "Discharged alive or dead.")

rm(Dead)
```


```{r Risk of death by hospital and hospital type Dots, fig.cap= 'Risk of death (per person) by hospital model and site.', fig.dpi=1200, fig.height=5, fig.width=7}
Dead <- HIPE %>%
  select(ModelF, HospCode, Died) %>%
  group_by(ModelF, HospCode, Died) %>%
  summarise(N = n()) %>%
  pivot_wider(names_from = Died, values_from = N) %>%
  ungroup() %>%
  mutate(Dead = ifelse(is.na(Dead), 0, Dead)) %>%
  mutate(Admissions = Alive+Dead) %>%
  mutate(Risk = Dead/(Admissions))

ggplot(data=Dead,
       aes(x=HospCode, y = Risk, colour = ModelF)) +
           geom_point(aes(size = Admissions)) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
    facet_wrap(~ModelF, scales = 'free_x') +
           labs( title = 'Risk of death by hospital model and site\n (point size is number of Admissions)',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Hospital code',
                 y = 'Risk of death') +
  guides(colour = "none", fill = "none", size = "none") +
    theme_minimal(base_size = 12)

rm(Dead)
```

It is important to emphasise that these crude death rates cannot be used to measure hospital outcomes, and still less to engage in the dubious activity of preparing league tables. Having said that, the results are not very surprising, and reflect the different roles and patient populations of the hospitals involved.

## Hospital coding

Different hospitals will provide different bundles of care. This is partly captured in the Hospital model. They may also have different coding practices. The coders receive common training, but the materials from they which they code may be more variable. To begin to address this, we start by examining the number of codes used in each hospital.

```{r Calculate code counts}
Coding_Summary <- HIPE %>%
  group_by(ModelF,HospCode) %>%
  summarise(across(c(age, ProcCount:HadxCount, ScoreEl, ScoreCh),
                   list(median = median, mean = mean, sd = sd)))
```

We show a series of hospital level variables.

### Age

Age at admission does not vary greatly between the main groups of hospitals. Note that this particular work is confined to an older group of patients, all aged 65 or over, and admitted for at least three days.

```{r Draw age}
ggplot(data = HIPE,
       aes(x = HospCode, y = age, colour = ModelF)) +
  geom_jitter(alpha = 0.05) +
  geom_violin() +
  facet_wrap(~ModelF, scales='free_x') +
  labs (title='Age',
        x = 'Hospital',
        y = 'Age (years)')
```

### Elixhauser score

All hospitals have a wide range of Elixhauser scores, but Model 4 hospitals have more of the highest scores than the others. The commonest score is zero. Neither of these is unexpected.

```{r ScoreEl}
ggplot(data = HIPE,
       aes(x = HospCode, y = ScoreEl, colour = ModelF)) +
  geom_jitter(alpha = 0.05) +
  geom_violin() +
  facet_wrap(~ModelF, scales='free_x') +
  labs (title='Elixhauser score',
        x = 'Hospital',
        y = 'Elixhauser score')
```

### Counts of codes given

Each discharge record has up to three sets of codes - a code for up to thirty diagnoses, a code for up to twenty procedures, and a code for up to thirty health care acquired diagnoses.

For diagnoses, there is considerable variability in the number of codes given, which partly reflects case mix, and partly coding practices.

```{r Diagnosis codes count}
ggplot(data = HIPE,
       aes(x = HospCode, y = DxCount, colour = ModelF)) +
  geom_jitter(alpha = 0.05) +
  geom_boxplot() +
  facet_wrap(~ModelF, scales='free_x') +
  labs (title='Number of diagnoses coded',
        x = 'Hospital',
        y = 'Number of Diagnoses coded')
```

A similar pattern can be seen for procedures, although there is some suggestions that practices in individual hospitals may be rather more different.

```{r Procedure codes count}
ggplot(data = HIPE,
       aes(x = HospCode, y = ProcCount, colour = ModelF)) +
  geom_jitter(alpha = 0.05) +
  geom_violin() +
  facet_wrap(~ModelF, scales='free_x') +
  labs (title='Number of procedures coded',
        x = 'Hospital',
        y = 'Number of Procedures coded')
```

For health care acquired diagnoses the median number of codes given is 0 in every hospital. The mean ranges from just over 0 to just over 2 depending on the hospitals, though there is substantial variability.

```{r HADx codes count}
ggplot(data = HIPE,
       aes(x = HospCode, y = HadxCount, colour = ModelF)) +
  geom_jitter(alpha = 0.05) +
  geom_boxplot() +
  facet_wrap(~ModelF, scales='free_x') +
  labs (title='Number of health care acquired diagnoses coded',
        x = 'Hospital',
        y = 'Number of Health care Acquired Diagnoses coded')
```

# Checking of the Chart Review data and the HIPE site data

## Check dataset and check matching

First, we produce a summary of the chart review dataset. Please review this, and be sure that all of the variables are correct.

## Data summary with the skimr library

```{r Check data skimr, results = 'asis'}
skimr::skim(Cost2Care.HIPE)
```

Note that hadx.01 and hadx.30 are both 100% missing. They are in the summary, but as logical variables.

## Check matching

It is desirable to check the matching, and see if the other HIPE.Site variables have the same values as those in the Cost2Care file.

There are two groups for comparison. 

### HIPE

In the first group the codes come from HIPE files, so the check is the correctness of the matching.

### UTI_hadx

```{r Check match tables UTI hadx code}

##################################################
# UTI
#
ctable(H.UTI_hadx <- as_factor(Cost2Care.HIPE$H.UTI_hadx),
  uti.hadx <- as_factor(Cost2Care.HIPE$uti.hadx),
  chisq = TRUE,
  prop = "n")

```

### DL_hadx

```{r Check match tables DL hadx code}
##################################################
# DL
#
ctable(H.DL_hadx <- as_factor(Cost2Care.HIPE$H.DL_hadx),
  delirium.hadx <- as_factor(Cost2Care.HIPE$delirium.hadx),
  chisq = TRUE,
  prop = "n")

```

### PU_hadx

```{r Check match tables PU hadx code}
##################################################
# PU
#
ctable(H.PU_hadx <- as_factor(Cost2Care.HIPE$H.PU_hadx),
  pressure.ulcer.hadx <- as_factor(Cost2Care.HIPE$pressure.ulcer.hadx),
  chisq = TRUE,
  prop = "n")

```

### PN_hadx

```{r Check match tables PN hadx code}
##################################################
# PN
#
ctable(H.PN_hadx <- as_factor(Cost2Care.HIPE$H.PN_hadx),
  pneumonia.hadx <- as_factor(Cost2Care.HIPE$pneumonia.hadx),
  chisq = TRUE,
  prop = "n")

```

## F2M

```{r Check match tables any failure to Maintain (F2M)}
##################################################
# F2M
#
#Check
#names(Cost2Care.HIPE)[which(str_detect(names(Cost2Care.HIPE),"hadx"))]
#
ctable(H.any_F2M_hadx <- as_factor(Cost2Care.HIPE$H.any_F2M_hadx),
  F2M <- as_factor(Cost2Care.HIPE$F2M),
  chisq = TRUE,
  prop = "n")

```

## Chart review vs. HIPE

In the second group, one code comes from the chart review, and the other from HIPE. This is the more substantively interesting

### Sex

```{r Check match tables Sex}
##################################################
# Sex
#
ctable(sex <- as_factor(
  Cost2Care.HIPE$sex),
  Cost2Care.HIPE$Gender,
  chisq = TRUE,
  prop = "n")

```

### Age

```{r Check match tables Age}
##################################################
# Age
#
freq(Cost2Care.HIPE$Age_discharge - Cost2Care.HIPE$age) # Mostly ok, i.e. 0, but a few large discrepancies

```


```{r Pictures, fig.cap= 'Age recorded from the chart review, against Age recorded in the HIPE data, for the study hospital.', fig.dpi=1200, fig.height=5, fig.width=7}
ggplot(data=Cost2Care.HIPE,
       aes(x = Age_discharge, y = age, colour=Gender)) + geom_jitter() # A bit clearer

```

### Elective or emergency admission

```{r Check match tables Elective or emergency admission}
##################################################
# elective or emergency admission
#
ctable(Cost2Care.HIPE$Elective_Emergency,
  Cost2Care.HIPE$elem,
  chisq = TRUE,
  prop = "n")

```

### ITU use

```{r Check match tables ITU use}
##################################################
# icu
#
ctable(itulos <- as_factor(Cost2Care.HIPE$itulos),
  Cost2Care.HIPE$ICU,
  chisq = TRUE,
  prop = "n")

```

###  PN

```{r Check match tables Pneumonia}
##################################################
# PN
#

PN <- as_factor(Cost2Care.HIPE$PN)
pneumonia <- fct_recode(as_factor(Cost2Care.HIPE$pneumonia),
                    Yes = "1",
                    No = "0")
ctable(PN, pneumonia,
  chisq = TRUE,
  prop = "n")

rm(PN, pneumonia)
```

### UTI

```{r Check match tables UTI}
##################################################
# UTI
#

UTI <- as_factor(Cost2Care.HIPE$UTI)
uti <- fct_recode(as_factor(Cost2Care.HIPE$uti),
                    Yes = "1",
                    No = "0")
ctable(UTI, uti,
  chisq = TRUE,
  prop = "n")

rm(UTI, uti)
```

### PU

```{r Check match tables Pressure ulcer}
##################################################
# PU
#
PU <- as_factor(Cost2Care.HIPE$PU)
pressure.ulcer <- fct_recode(as_factor(Cost2Care.HIPE$pressure.ulcer),
                    Yes = "1",
                    No = "0")
ctable(PU, pressure.ulcer,
  chisq = TRUE,
  prop = "n")

rm(PU, pressure.ulcer)
```

### DL

```{r Check match tables Delirium}
##################################################
# DL
#

DL <- as_factor(Cost2Care.HIPE$DL)
delirium <- fct_recode(as_factor(Cost2Care.HIPE$delirium),
                    Yes = "1",
                    No = "0")
ctable(DL,delirium,
  chisq = TRUE,
  prop = "n")

rm(DL, delirium)
```

### F2M

```{r Check match tables F2M}
##################################################
# F2M
#
#Check
#names(Cost2Care.HIPE)[which(str_detect(names(Cost2Care.HIPE),"hadx"))]
#
H.any_F2M <- as_factor(Cost2Care.HIPE$H.any_F2M)
F2M <- as_factor(Cost2Care.HIPE$F2M)

ctable(H.any_F2M, F2M,
  chisq = TRUE,
  prop = "n")

rm(H.any_F2M, F2M)
```

# Major outcomes

The main outcomes available are 

* the presence of a health care associated urinary tract infection (UTI - variable beginning with 'UTI.')
* the presence of health care associated pneumonia (PN - variable beginning with 'PN.')
* the presence of a health care associated pressure ulcer (PU - variable beginning with 'PU.')
* the presence of health care associated delirium infection (DL - variable beginning with 'DL.')
* Failure to maintain - i.e. any one or more of the above (F2M)
* Death recorded
* Prolonged length of stay

It is wholly possible to have several of these outcomes.

# Finalise analysis data

## Remove Maternity and Specialist hospitals

The HIPE dataset contains data from Model 4, Model 3 and Model 2 hospitals, as a well as the three large maternity hospitals in Dublin `r table(HIPE$ModelF)[[5]]` discharges, and five specialist hospitals, `r table(HIPE$ModelF)[[4]]` discharges. There is fair evidence, as shown above, that the latter two groups are rather different from the first three. There is also a case for removing the Model 2 hospitals, which account for  small proportion of total admissions, and serve rather different roles. Following discussion with the team, the `r table(HIPE$ModelF)[[3]]` Model 2 discharges were removed from the saved HIPE file. We also remove the corresponding factor levels from both the national HIPE file, and the chart review site file.

```{r Drop Model 2 specialist and maternity hospitals and corresponding factor levels}

HIPE <- HIPE %>%
    filter(ModelF %in% c('Model 4','Model 3')) %>%
    mutate(ModelF = fct_drop(ModelF)) %>%
      mutate(HospCode = fct_drop(HospCode))

HIPE.Site <- HIPE.Site %>%
    filter(ModelF %in% c('Model 4','Model 3')) %>% # Keep only Model 3 and Model 4 hospitals, in fact there is only one Model 4 hospital in the Site data.
    mutate(ModelF = fct_drop(ModelF)) %>% # Drop the unused factor levels
    mutate(HospCode = fct_drop(HospCode))

# Ensure factor levels are the same between HIPE and HIPE.SITE
HIPE.Site$ModelF <- fct_expand(HIPE.Site$ModelF,
                               levels(HIPE$ModelF),
                               after = Inf)

HIPE.Site$HospCode <- fct_inseq(fct_expand(HIPE.Site$HospCode,
                               levels(HIPE$Hospcode),
                               after = Inf))

```

## Define sampling weights

The chart review was augmented to secure roughly equal number of medical and surgical admissions. This leads to a sizeable over-inclusion of surgical admissions in the data, relative to the totality of admissions. To account for this, we need to define a weighting variable.

The first table shows the proportion of medical and surgical patients in the chart review data, using two measures, the speciality of admission, and the use (or otherwise) of an anaesthetic.

```{r Chart review breakdown}
W.C <- HIPE.Site %>%
  mutate(AN = ifelse(Anaesthesia > 0, 'Yes', 'No')) %>%
  select(ModelF, HospCode, MedSurg, AN)
#table(H.C$MedSurg)
#table(H.C$AN)
ctable(W.C$MedSurg,W.C$AN, prop = 't')

```

The second is the corresponding table for all discharges in the chart review hospital.

```{r Study site breakdown}
W.S <- HIPE |>
  filter(HospCode == '4.1') %>%
    mutate(AN = ifelse(Anaesthesia > 0, 'Yes', 'No'))  %>%
  select(ModelF, HospCode, MedSurg, AN)

#table(H.S$MedSurg)
#table(H.S$AN)
ctable(W.S$MedSurg,W.S$AN, prop='t')

```

The third shows the same in all the model 3 and 4 hospitals.

```{r Model 3 and 4 breakdown}
W.A <- HIPE |>
  group_by(ModelF) %>%
    mutate(AN = ifelse(Anaesthesia > 0, 'Yes', 'No'))  %>%
  select(ModelF, HospCode, MedSurg, AN)

#table(H.A$MedSurg)
#table(H.A$AN)
ctable(W.A$MedSurg,W.A$AN, prop = 't')

```

Pulling these together, it's possible to calculate sampling weights, as inverse probability weights - these are the number of people in the population represented by each person in the chart review.

```{r Calculate the weights}
##############################################################
# Calculate the totals for each group
# 
W.C <- W.C |> # Study site Chart review cases
  group_by(ModelF, HospCode, MedSurg, AN) |>
  summarise(N.C = n())
W.S <- W.S |> # Study site total
  group_by(ModelF, HospCode, MedSurg, AN) |>
  summarise(N.S = n())
W.A <- W.A |> # All Model 3 and Model 4
  group_by(ModelF, HospCode, MedSurg, AN) |>
  summarise(N.A = n())

##############################################################
# Calculate weights to indicate how many discharges each
# sampled discharge represents
# 
Weights <- W.C |>
  full_join(W.S,by = join_by(ModelF, HospCode, MedSurg, AN))  |>
  mutate(Ratio = N.C/N.S) |>
  mutate(Weights = 1/Ratio) |>
  mutate(Check = N.C * Weights)

##############################################################
# Add the Weight variable to the Cost2Care.HIPE file
#
Cost2Care.HIPE <- Cost2Care.HIPE |>
  mutate(AN = ifelse(Anaesthesia > 0, 'Yes', 'No'))  |>
  right_join(Weights |> ungroup() |> select(MedSurg, AN, Weights),
             by = join_by(MedSurg, AN)) |>
  select(-AN)

##############################################################
# Add the Weight variable to the HIPE.Site file
#
HIPE.Site <- HIPE.Site |>
  mutate(AN = ifelse(Anaesthesia > 0, 'Yes', 'No'))  |>
  right_join(Weights |> ungroup() |> select(MedSurg, AN, Weights),
             by = join_by(MedSurg, AN)) |>
  select(-AN)

##############################################################
# Add the Weight variable to the HIPE file
#
HIPE <- HIPE |>
  mutate(Weights = 1)

rm(W.A, W.C, W.S)
```

```{r Weights table}
kable(Weights)
```

# Produce simplified files

We omit records where the outcome is missing - these are the two discussed previously. We leave out date records, text descriptions, and the variable 'rawlos' (which is another version of the LosC variable!). This gives us a working study site file, C2C.H.

We similarly simplify the HIPE National file HIPE to H.N, and the HIPE site file to H.S.

```{r simplify data}
 
CTC.H <- Cost2Care.HIPE %>%
    filter(!is.na(LOS)) %>%
    select(StudyID, Gender_consensus, Age_consensus,
           PN, UTI, PU, DL, F2M,MedSurg,
           Elective_Emergency, Ward_moves, Bed_moves,
           Training:proc.desc.20) %>%
    select(-c(DateOfAdmission, DateOfDischarge,
              MonthOfAdmission, MonthOfDischarge,
              mon.adm, ICD_combined)
                  ) %>%
  select(-c(rawlos,
            uti, delirium, pressure.ulcer, pneumonia,
            uti.hadx, delirium.hadx, pressure.ulcer.hadx,
            pneumonia.hadx,
            any.f2m, any.f2m.hadx)) %>%
  select(!contains('desc')) %>% # Basically HIPE text variables
  select(!starts_with('proc.')) %>%
  select(!starts_with('dx.')) %>%
  select(!starts_with('hadx.')) %>%
  select(!ends_with('Ch')) %>% # Charlson score and components
  mutate(Elixhauser = ScoreEl) %>% # Keep Elixhauser score
  select(!ends_with('El')) # Elixhauser score components only

H.N <- HIPE %>%
    filter(!is.na(LosC)) %>%
#    select(StudyID, Gender_consensus, Age_consensus,
#           PN, UTI, PU, DL, F2M,MedSurg,
#           Elective_Emergency, Ward_moves, Bed_moves,
#           Training:proc.desc.20) %>%
    select(-c(DateOfAdmission, DateOfDischarge,
              MonthOfAdmission, MonthOfDischarge,
              mon.adm, ICD_combined)
                  ) %>%
  select(-c(rawlos,
            uti, delirium, pressure.ulcer, pneumonia,
            uti.hadx, delirium.hadx, pressure.ulcer.hadx,
            pneumonia.hadx,
            any.f2m, any.f2m.hadx)) %>%
  select(!contains('desc')) %>% # Basically HIPE text variables
  select(!starts_with('proc.')) %>%
  select(!starts_with('dx.')) %>%
  select(!starts_with('hadx.')) %>%
  select(!ends_with('Ch')) %>% # Charlson score and components
  mutate(Elixhauser = ScoreEl) %>% # Keep Elixhauser score
  select(!ends_with('El')) # Elixhauser score components only
 

H.S <- HIPE.Site %>%
    filter(!is.na(LosC)) %>%
#    select(StudyID, Gender_consensus, Age_consensus,
#           PN, UTI, PU, DL, F2M,MedSurg,
#           Elective_Emergency, Ward_moves, Bed_moves,
#           Training:proc.desc.20) %>%
    select(-c(DateOfAdmission, DateOfDischarge,
              MonthOfAdmission, MonthOfDischarge,
              mon.adm, ICD_combined)
                  ) %>%
  select(-c(rawlos,
            uti, delirium, pressure.ulcer, pneumonia,
            uti.hadx, delirium.hadx, pressure.ulcer.hadx,
            pneumonia.hadx,
            any.f2m, any.f2m.hadx)) %>%
  select(!contains('desc')) %>% # Basically HIPE text variables
  select(!starts_with('proc.')) %>%
  select(!starts_with('dx.')) %>%
  select(!starts_with('hadx.')) %>%
  select(!ends_with('Ch')) %>% # Charlson score and components
  mutate(Elixhauser = ScoreEl) %>% # Keep Elixhauser score
  select(!ends_with('El')) # Elixhauser score components only
```

# Save files

```{r Save the files}
# Site review + HIPE
saveRDS(Cost2Care.HIPE, file = "data/Cost2Care.HIPE.Rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)

saveRDS(CTC.H, file = "data/CTC.H.Rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)

# HIPE for country
saveRDS(HIPE, file = "data/HIPE.Rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)

saveRDS(H.N, file = "data/H.N.Rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)

# HIPE for site data only
saveRDS(HIPE.Site, file = "data/HIPE.Site.Rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)

saveRDS(H.S, file = "data/H.S.Rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)

```

