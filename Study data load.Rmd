---
title: "Study data load"
author: "Anthony Staines"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    fig_caption: true
    number_sections: true
    latex_engine: xelatex
    includes:
      in_header: 
      - !expr system.file("includes/fig-valign.tex", package = "summarytools")
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
bibliography: references.bib
csl: vancouver.csl
---

# Summary

This file loads both the study data, and the HIPE data for the study hospital, a Model 4 hospital, and merges these.

```{r setup, include=FALSE}
rm(list=ls())

library(tidyverse)
library(lubridate)
library(tibble)
library(readxl)
library(comorbidity)
library(tidymodels)
library(lme4)
#library(lmerTest)
library(knitr)
library(kableExtra)
library(summarytools)

library(sjPlot)
library(sjtable2df)
library(broom)
library(broom.mixed)

library(pixiedust)
library(stargazer)


tidymodels_prefer(quiet = TRUE)

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = NA, message = NA, fig.pos = 'H',
      cache.extra = knitr::rand_seed)

st_options(ctable.round.digits = 2)
N = 16

options(Ncpus = N)
options(dplyr.summarise.inform = FALSE, # shut up summarise
        ranger.num.threads = N) # Prepare for rf models

set.seed(979)
rm(N)
```

# Load the study and HIPE data files

```{r Load files}
#####################################################
# Check the sheet names (Note the extra ' ' in the "Chart review data ")
# 
excel_sheets('data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx')

#####################################################
# Load the study data
# 
Cost2Care <- read_excel(path='data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx',
                        sheet = 'Chart review data ',
                        range = "A2:FV1002")

#####################################################
# Fix the names
# PN - PNeumonia;       UTI - Urinary Tract Infection;
# PU - Pressure Ulcer;  DL - DeLirium
# 
    NAMES <- read_excel(
      'data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx',
      sheet = 'NAMES')
          names(Cost2Care) <- NAMES$Chart_review_data_revised

#####################################################
# Remove 5 empty columns with missing names
# 
Cost2Care <- Cost2Care %>%
  select(-c(which(is.na(names(Cost2Care)))))

#####################################################
# Load the corresponding HIPE data
# 
HIPE.Site <- readRDS('data/Hipe.Site.rds')

#####################################################
# Note there are 2 StudyIDs 41 and 405 which are 
# not in the Cost2Care file, but are in the HIPE.Site file
COMBINED <- full_join(
  Cost2Care %>%
    select(StudyID, encrypted_mrn),
  HIPE.Site %>%
    select(StudyID, ID),
      by = join_by(StudyID)) # check for missing study IDS

#####################################################
# Join the main files
# 
Cost2Care.HIPE <- full_join(
    Cost2Care,
    HIPE.Site,
    by = join_by(StudyID))

##################################################
# Duplicate names - fixed in Cost2Care working spreadsheet sheet NAMES
# 'data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx'
#
NN <- names(Cost2Care.HIPE)
NN[c(which(str_detect(NN, "\\.y|\\.x")))] # Should be PN.xray only
#rm(COMBINED, NAMES)
```

# Check dataset and check matching

First, we produce two summaries of the dataset. Please review these, and be sure that they are correct.

## skimr

```{r Check data skimr, results = 'asis'}
skimr::skim(Cost2Care.HIPE)
```

## df Summary

```{r Check data dfSummary, results = 'asis'}
ST <- dfSummary(Cost2Care.HIPE,
                plain.ascii = FALSE,
                style='grid',
                graph.magnif = 0.85,
                varnumbers = FALSE,
                valid.col = FALSE,
                tmp.img.dir  = "/tmp")

print(ST, method = 'render')
```

## Check matching

It is desirable to check the matching, and see if the other HIPE.Site variables have the same values as those in the Cost2Care file. All of these tables should be diagonal only, but they are not.

```{r Check match tables}
ctable(sex <- as_factor(Cost2Care.HIPE$sex),
+       Cost2Care.HIPE$gender)

# Oops

freq(Cost2Care.HIPE$age_discharge - Cost2Care.HIPE$age) # Mostly ok, i.e. 0, but a few large discrepancies



```

```{r Pictures}
ggplot(data=Cost2Care.HIPE,
       aes(x = age_discharge, y = age, colour=gender)) + geom_jitter() # A bit clearer

```

# Major outcomes

The main outcomes available are 
* the presence of a health care associated urinary tract infection (UTI - variable beginning with 'UTI.')
* the presence of health care associated pneumonia (PN - variable beginning with 'PN.')
* the presence of a health care associated pressure ulcer (PU - variable beginning with 'PU.')
* the presence of health care associated delirium infection (DL - variable beginning with 'DL.')
* Death recorded
* Prolonged length of stay

It is wholly possible to have several of these outcomes.
