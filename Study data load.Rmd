---
title: "Study data load"
author: "Anthony Staines"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    fig_caption: true
    number_sections: true
    latex_engine: xelatex
    includes:
      in_header: 
      - !expr system.file("includes/fig-valign.tex", package = "summarytools")
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
bibliography: references.bib
csl: vancouver.csl
---

# Summary

This file loads both the study data, and the HIPE data for the study hospital, a Model 4 hospital, and merges these.

```{r setup, include=FALSE}
rm(list=ls())

library(tidyverse)
library(lubridate)
library(tibble)
library(readxl)
library(comorbidity)
library(tidymodels)
library(lme4)
#library(lmerTest)
library(knitr)
library(kableExtra)
library(summarytools)

library(sjPlot)
library(sjtable2df)
library(broom)
library(broom.mixed)

library(pixiedust)
library(stargazer)


tidymodels_prefer(quiet = TRUE)

knitr::opts_chunk$set(echo = FALSE, cache = TRUE, warning = NA, message = NA, fig.pos = 'H',
      cache.extra = knitr::rand_seed)

st_options(ctable.round.digits = 2)
N = 16

options(Ncpus = N)
options(dplyr.summarise.inform = FALSE, # shut up summarise
        ranger.num.threads = N) # Prepare for rf models

set.seed(979)
rm(N)
```

# Load the study and HIPE data files

```{r Load files}
#####################################################
# Check the sheet names (Note the extra ' ' in the "Chart review data ")
# 
excel_sheets('data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx')

#####################################################
# Load the study data
# 
Cost2Care <- read_excel(path='data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx',
                        sheet = 'Chart review data ',
                        range = "A2:FV1002")

#####################################################
# Fix the names
# PN - PNeumonia;       UTI - Urinary Tract Infection;
# PU - Pressure Ulcer;  DL - DeLirium
# 
    NAMES <- read_excel(
      'data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx',
      sheet = 'NAMES')
          names(Cost2Care) <- NAMES$Chart_review_data_revised

#####################################################
# Remove 5 empty columns with missing names
# 
Cost2Care <- Cost2Care %>%
  select(-c(which(is.na(names(Cost2Care)))))

#####################################################
# Load the corresponding HIPE data
# 
HIPE.Site <- readRDS('data/Hipe.Site.rds')

#####################################################
# Note there are 2 StudyIDs 41 and 405 which are 
# not in the Cost2Care file, but are in the HIPE.Site file
COMBINED <- full_join(
  Cost2Care %>%
    select(StudyID, Encrypted_mrn),
  HIPE.Site %>%
    select(StudyID, ID),
      by = join_by(StudyID)) # check for missing study IDS

#####################################################
# Join the main files
# 
Cost2Care.HIPE <- full_join(
    Cost2Care,
    HIPE.Site,
    by = join_by(StudyID))

##################################################
# Duplicate names - fixed in Cost2Care working spreadsheet sheet NAMES
# 'data/Clean Cost2Care Merged Chart Review and HIPE Data_WORKING.xlsx'
#
NN <- names(Cost2Care.HIPE)
NN[c(which(str_detect(NN, "\\.y|\\.x")))] # Should be PN.xray only
#rm(COMBINED, NAMES)
```

# Check dataset and check matching

First, we produce two summaries of the dataset. Please review these, and be sure that they are correct.

## skimr

```{r Check data skimr, results = 'asis'}
skimr::skim(Cost2Care.HIPE)
```

## df Summary

```{r Check data dfSummary, results = 'asis'}
ST <- dfSummary(Cost2Care.HIPE,
                plain.ascii = FALSE,
                style='grid',
                graph.magnif = 0.85,
                varnumbers = FALSE,
                valid.col = FALSE,
                tmp.img.dir  = "/tmp")

print(ST, method = 'render')
```


## Check matching

It is desirable to check the matching, and see if the other HIPE.Site variables have the same values as those in the Cost2Care file.

There are two groups for comparison. 

## HIPE

In the first group the codes come from HIPE files, so the check is the correctness of the matching.

### UTI_hadx

```{r Check match tables UTI hadx code}
##################################################
# UTI
#
ctable(H.UTI_hadx <- as_factor(Cost2Care.HIPE$H.UTI_hadx),
  uti.hadx <- as_factor(Cost2Care.HIPE$uti.hadx),
  chisq = TRUE,
  prop = "n")

```

### DL_hadx

```{r Check match tables DL hadx code}
##################################################
# DL
#
ctable(H.DL_hadx <- as_factor(Cost2Care.HIPE$H.DL_hadx),
  delirium.hadx <- as_factor(Cost2Care.HIPE$delirium.hadx),
  chisq = TRUE,
  prop = "n")

```

### PU_hadx

```{r Check match tables PU hadx code}
##################################################
# PU
#
ctable(H.PU_hadx <- as_factor(Cost2Care.HIPE$H.PU_hadx),
  pressure.ulcer.hadx <- as_factor(Cost2Care.HIPE$pressure.ulcer.hadx),
  chisq = TRUE,
  prop = "n")

```

### PN_hadx

```{r Check match tables PN hadx code}
##################################################
# PN
#
ctable(H.PN_hadx <- as_factor(Cost2Care.HIPE$H.PN_hadx),
  pneumonia.hadx <- as_factor(Cost2Care.HIPE$pneumonia.hadx),
  chisq = TRUE,
  prop = "n")

```

## There are a couple of anyf2m variable floating about - can we check which is which? I think h.any_f2m comes from the chart review, and h.any_f2m.hadx comes from HIPE?

```{r Check match tables any failure to Maintain (F2M)}
##################################################
# any_F2M
#
#Check
#names(Cost2Care.HIPE)[which(str_detect(names(Cost2Care.HIPE),"hadx"))]
#
ctable(H.any_F2M_hadx <- as_factor(Cost2Care.HIPE$H.any_F2M_hadx),
  any.f2m.hadx <- as_factor(Cost2Care.HIPE$any.f2m.hadx),
  chisq = TRUE,
  prop = "n")

```

## Chart review vs. HIPE

In the second group, one code comes from the chart review, and the other from HIPE. This is the more substantively interesting

### Sex

```{r Check match tables Sex}
##################################################
# Sex
#
ctable(sex <- as_factor(
  Cost2Care.HIPE$sex),
  Cost2Care.HIPE$Gender,
  chisq = TRUE,
  prop = "n")

```

### Age

```{r Check match tables Age}
##################################################
# Age
#
freq(Cost2Care.HIPE$Age_discharge - Cost2Care.HIPE$age) # Mostly ok, i.e. 0, but a few large discrepancies

```

### Elective or emergency admission

```{r Check match tables Elective or emergency admission}
##################################################
# elective or emergency admission
#
ctable(Cost2Care.HIPE$Elective_emergency,
  Cost2Care.HIPE$elem,
  chisq = TRUE,
  prop = "n")

```

### ITU use

```{r Check match tables ITU use}
##################################################
# icu
#
ctable(itulos <- as_factor(Cost2Care.HIPE$itulos),
  Cost2Care.HIPE$ICU,
  chisq = TRUE,
  prop = "n")

```

###  PN

```{r Check match tables Pneumonia}
##################################################
# PN
#
ctable(PN <- as_factor(Cost2Care.HIPE$PN),
  pneumonia <- as_factor(Cost2Care.HIPE$pneumonia),
  chisq = TRUE,
  prop = "n")

```

### UTI

```{r Check match tables UTI}
##################################################
# UTI
#
ctable(UTI <- as_factor(Cost2Care.HIPE$UTI),
  uti <- as_factor(Cost2Care.HIPE$uti))

```

### PU

```{r Check match tables Pressure ulcer}
##################################################
# PU
#
ctable(PU <- as_factor(Cost2Care.HIPE$PU),
  pressure.ulcer <- as_factor(Cost2Care.HIPE$pressure.ulcer))

```

### DL

```{r Check match tables Delirium}
##################################################
# DL
#
ctable(DL <- as_factor(Cost2Care.HIPE$DL),
  delirium <- as_factor(Cost2Care.HIPE$delirium))

```

### Any F2M

```{r Check match tables Any F2M}
##################################################
# any_2FM
#
#Check
#names(Cost2Care.HIPE)[which(str_detect(names(Cost2Care.HIPE),"hadx"))]
#
ctable(H.any_F2M <- as_factor(Cost2Care.HIPE$H.any_F2M),
  any.f2m <- as_factor(Cost2Care.HIPE$any.f2m))

```

```{r Pictures}
ggplot(data=Cost2Care.HIPE,
       aes(x = Age_discharge, y = age, colour=Gender)) + geom_jitter() # A bit clearer

```

# Major outcomes

The main outcomes available are 
* the presence of a health care associated urinary tract infection (UTI - variable beginning with 'UTI.')
* the presence of health care associated pneumonia (PN - variable beginning with 'PN.')
* the presence of a health care associated pressure ulcer (PU - variable beginning with 'PU.')
* the presence of health care associated delirium infection (DL - variable beginning with 'DL.')
* Death recorded
* Prolonged length of stay

It is wholly possible to have several of these outcomes.

# Save file

```{r Save the files}
saveRDS(Cost2Care.HIPE, file = "data/Cost2Care.Hipe.rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)
```
