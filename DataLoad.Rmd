---
title: "Data load"
author: "Anthony Staines"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    fig_caption: true
    number_sections: true
    latex_engine: xelatex
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
bibliography: references.bib
csl: vancouver.csl
---

# Aims

This file loads both the main HIPE data, and the HIPE data for the study hospital, a Model 4 hospital, and establishes a base model for length of stay.

```{r setup, include=FALSE}
rm(list=ls())

library(tidyverse)
library(lubridate)
library(tibble)
library(comorbidity)
library(tidymodels)
library(lme4)
#library(lmerTest)
library(knitr)
library(kableExtra)

library(sjPlot)
library(sjtable2df)
library(broom)
library(broom.mixed)

library(pixiedust)
library(stargazer)


tidymodels_prefer(quiet = TRUE)

knitr::opts_chunk$set(echo = FALSE, cache = TRUE,
                      warning = NA, message = NA,
                      fig.pos = 'H',
                      cache.extra = knitr::rand_seed)

N = 16

options(Ncpus = N)
options(dplyr.summarise.inform = FALSE, # shut up summarise
        ranger.num.threads = N) # Prepare for rf models

set.seed(979)
rm(N)
```

# Load main HIPE data files

First we load the data, and then keep 1/5 of the rows for testing, leaving 4/5 for training.

```{r Load main data file, results = 'hide'}
HIPE <- as_tibble(read.csv("data/H240272_2022.csv",
        strip.white = TRUE, na.strings = c("", NA)))

###################################################
#There is a StudyID variable at the start of the HIPE site file, so we add a blank StudyID to the start of this HIPE file
#
HIPE <- HIPE %>%
  mutate(StudyID = 0)

HIPE.Site <- as_tibble(
  read.csv("data/H240272_2022_Site_Study_Subjects.csv", strip.white = TRUE, na.strings = c("", NA)))
```

```{r Function <HIPE_PROCESS> to process both HIPE files}
HIPE_PROCESS <- function (HIPE_FILE) {
#############################################
# tidy up the names in the files provided
# 
  names(HIPE_FILE)
    names(HIPE_FILE) <- str_to_lower(names(HIPE_FILE)) # All lower case
    names(HIPE_FILE) <- str_replace_all(names(HIPE_FILE), "_", ".") # no _, use . instead
    names(HIPE_FILE) <- str_replace(names(HIPE_FILE), "(\\d*$)", ".\\1") # A dot place before any digits at the end, otherwise at the end
    names(HIPE_FILE) <- str_replace(names(HIPE_FILE), "(\\.$)", "") # Remove unwanted dots at the end, those not followed by digits.

#############################################
# Set up an ID variable
#   
HIPE_FILE <- HIPE_FILE %>%
  mutate(rowid_to_column(., var = "ID")) %>% # Numeric ID
  mutate(ID = paste0("ID.",ID, sep = '')) # Character ID

#############################################
# Calculate some time related variables
# 
HIPE_FILE <- HIPE_FILE %>%
  mutate(DateOfAdmission = paste0('15',mon.adm)) %>% # Process dates in MY format correctly, set day to 15th of each month
  mutate(DateOfAdmission = dmy(DateOfAdmission)) %>%
  mutate(DateOfDischarge = (DateOfAdmission + rawlos)) %>% # Crude estimate of date of discharge, but all we want is winter/not_winter
  mutate(MonthOfAdmission = lubridate::month(DateOfAdmission, label=TRUE)) %>%
  mutate(MonthOfDischarge = lubridate::month(DateOfDischarge, label=TRUE)) %>%
  mutate(SeasonOfAdmission =
           case_match(MonthOfAdmission,
                      c("Nov","Dec","Jan", "Feb") ~ "Winter",
c("Mar","Apr","May","Jun","Jul","Aug","Sep","Oct") ~ "Other"
                                    ))
#############################################
# Prepare a SpecialtyGroup variable
#

    
    
#############################################
# Then we split into training and test datasets
# 
HIPE_FILE_split <- initial_split(HIPE_FILE, prop = 4/5, strata = hosp.anon)

# Add a training variable to the dataframe

HIPE_FILE <- HIPE_FILE %>%
  mutate(Training = FALSE)

# Add a variable to indicate training set or test set.
 HIPE_FILE$Training[HIPE_FILE_split$in_id] <- TRUE

#############################################
# Add Hospital Model codes
HIPE_FILE <- HIPE_FILE %>%
    # Now we reorder the group
    mutate(MODELX = as_factor(model)) %>%
    mutate(ModelF = fct_relevel(
        MODELX,
        c("Model 4", "Model 3", "Model 2", "Specialist", "Maternity" ),
        after = Inf)) %>%
    select (-MODELX) %>%
    # now we identify the group
    mutate(ModelCode = case_match(model,
        'Model 4' ~ '4',
        'Model 3' ~ '3',
        'Model 2' ~ '2',
        'Specialist' ~ 'S',
        'Maternity' ~ 'M'
    ))

#############################################
# Make short per hospital codes
CODES <- HIPE_FILE %>%
    select(ModelCode, hosp.anon) %>%
    group_by(ModelCode) %>% 
    arrange(ModelCode, hosp.anon) %>%
    distinct() %>%
    mutate(HospNo = row_number()) %>%
    mutate(HospCode = paste0(ModelCode, '.', HospNo)) %>%
    mutate(HospCode = fct_inorder(HospCode))

# Merge the short codes back into the main dataset

HIPE_FILE <- HIPE_FILE %>%
    left_join(CODES, by = join_by(hosp.anon, ModelCode))

#############################################
# Sensibly code Source and Destination
# 
# 
HIPE_FILE <- HIPE_FILE %>%
    mutate(Source = case_match(source,
                            1 ~ "Home",
                            2 ~ "Care",
                            3 ~ "Transfer",
                            c(0,4,5,6,7,8,9) ~ "Other")) %>%
    mutate(Died = case_match(discode,
                            c(6,7) ~ "Dead",
                            c(0,1,2,3,4,5,
                              8,9,10,11,
                              12,13,14,15) ~ "Alive")) %>%
    mutate(Outcome = case_match(discode,
                            1 ~ "Home",
                            c(2,11) ~ "Care", # includes hospice
                            c(3,4,5,8,9,10) ~ "Transfer",
                            c(6,7) ~ "Dead",
                            c(0,12,13,14,15) ~ "Other"))

#############################################
# Scoring - Calculate Elixhauser and Charlson codes
# 
HIPE_FILE <- HIPE_FILE %>%
  unite("ICD_combined", dx.01:dx.30, sep=' ',
        remove = FALSE, na.rm=TRUE) # comorbidity expects a single variable containing all the ICD10 codes to be used as a a string, hence ICD-combined - This is a *BAD* idea.

#############################################
# Charlson
charlson <- comorbidity(x = HIPE_FILE, id = "ID", code = "ICD_combined", map = "charlson_icd10_am", assign0 = FALSE)
    charlson <- charlson %>% 
      mutate(score = score(charlson, weights='quan', assign0 = TRUE))
        names(charlson)[-1] <- paste0(str_to_title(names(charlson)[-1]),
                                      'Ch', sep='')

#############################################
# Elixhauser
elixhauser <- comorbidity(x = HIPE_FILE, id = "ID", code = "ICD_combined", map = "elixhauser_icd10_quan", assign0 = FALSE)
    elixhauser <- elixhauser %>% 
      mutate(score = score(elixhauser, weights='swiss', assign0 = TRUE))
        names(elixhauser)[-1] <- paste0(str_to_title(names(elixhauser)[-1]),
                                        'El', sep='')

#############################################
# Put the scores back in the main file
HIPE_FILE <- HIPE_FILE %>%
  left_join(charlson, by = join_by(ID), suffix = c("", ".ch")) %>%
  left_join(elixhauser, by = join_by(ID),suffix = c("", ".el"))

#############################################
# Ad a count of procedures, diagnoses and hadx scores
# 
HIPE_FILE <- HIPE_FILE %>%
  mutate(ProcCount = purrr::pmap_dbl(HIPE_FILE %>% select(proc.01:proc.20),
                           ~sum(!is.na(c(...))))) %>%
  mutate(DxCount = purrr::pmap_dbl(HIPE_FILE %>% select(dx.01:dx.30),
                           ~sum(!is.na(c(...))))) %>%
  mutate(HadxCount = purrr::pmap_dbl(HIPE_FILE %>% select(hadx.01:hadx.20),
                           ~sum(!is.na(c(...)))))

#############################################
# Centre and scale age, rawlos and other numeric variables
# 
HIPE_FILE <- HIPE_FILE %>%
  mutate(AgeC = as.vector(scale(age))) %>%
  mutate(LosC = as.vector(scale(rawlos)))

#
## scale produces a matrix output
#

#############################################
# Select and order the desired variables
# This will *change* if more calculated variables are added
# 
HIPE_FILE <- HIPE_FILE %>%
  mutate(StudyID = studyid) %>% #Capitalise this again
  select(StudyID, ID, Training, ModelF, ModelCode, HospCode,
         AgeC, LosC,
         DateOfAdmission, MonthOfAdmission, SeasonOfAdmission,
         DateOfDischarge, MonthOfDischarge,
         ScoreEl, ScoreCh, HospNo:Outcome, ProcCount:HadxCount,
         hosp.anon:proc.desc.20) # Reorder variables

#############################################
# Finish, returning a single tibble
#
    return(HIPE_FILE)
}

```

```{r Process both files}

HIPE <- HIPE_PROCESS(HIPE)
HIPE.Site <- HIPE_PROCESS(HIPE.Site)
```

```{r Calculate some useful numbers}
#str(DATA, list.len = 200)
# some relevant figures
  PEOPLE <- nrow(HIPE)
  HOSPITALS <- length(unique(HIPE$hosp.anon))
  STUDY <- nrow(HIPE.Site)

```

There are a total of `r PEOPLE` admissions in these records, from `r HOSPITALS` different hospitals. Of these `r STUDY` from one Model 4 hospital took part in the chart review study.

```{r Delete the numbers}
rm(PEOPLE, HOSPITALS, STUDY)
```

The next step is to create a number of additional variables required for analysis and data display. These mostly consist of a re-ordering of the 'model' variable, which indicates the type of hospital (Model 4, Model 3 Model 2, Specialist, or Maternity) and the creation of hospital ID's which number the hospitals within these groups.

# Outcomes

## Timing of admissions

Although some of the admissions were a very long time before discharge, most occurred during late 2021 and  2022, as Figure 1 shows.

```{r Admission dates by time, fig.cap= 'Admission dates by month and year for discharges included in the analysis.', fig.dpi=600, fig.height=4, fig.width=6}
Admissions <- HIPE %>%
    group_by(DateOfAdmission) %>%
    summarise(N = n())

ggplot(data=Admissions,
       aes(x=DateOfAdmission, y= N)) +
           geom_point(colour = 'red',
                      size = 3) +
    scale_x_date(date_breaks = '6 months',
                 date_labels = '%b_%y') +
           labs( title = 'Admissions per month in data set',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Date of admission',
                 y = 'Count') +
    theme_minimal(base_size = 12)
       
rm(Admissions)
```

# Comorbidity scores

It can be useful to consider comorbidity scores, and two of the most popular of these are the Elixhauser  and Charlson  scores. These are calculated using in this work using the comorbidity package , in turn based on.

Figure 3 shows the joint and separate distributions of these scores amongst the discharges.  The very limited range of Charlson scores encountered, is contrasted with the much wider range of the Elixhauser scores.

```{r Plot of E & C scores, fig.cap= 'Plot of Elixhauser and Charlson weighted scores for the discharges included in the analysis.', fig.dpi=1200, fig.height=5, fig.width=7}
ggplot(data=HIPE,
       aes(x = ScoreCh, y = ScoreEl,
           fill = ModelCode, colour = ModelCode)) +
  geom_tile() +
  facet_wrap(~ModelCode) +
           labs( title = 'Plot of Elixhauser and Charlson weighted scores',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Charlson Score',
                 y = 'Elixhauser Score') +
  guides(colour = guide_legend("Hospital\nModel"),
         fill = guide_legend("Hospital\nModel")) +
    theme_minimal(base_size = 12)
```

## Length of stay

Lengths of stay varied greatly also, as Figure 2 shows. Model of hospital was one important source of variation, but between hospitals there is also evidence of considerable variation. In part, this is to be expected, given the differing roles of Model 4, Model 3, and Model 2 hospitals.

```{r Length of stay by hospital and hospital type, fig.cap= 'Length of stay (days) by hospital model and site (outliers excluded).', fig.dpi=1200, fig.height=5, fig.width=7}


ggplot(data=HIPE,
       aes(x=HospCode, y = rawlos, colour = ModelF)) +
           geom_boxplot(outliers = FALSE, varwidth = TRUE) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
    facet_wrap(~ModelF, scales = 'free') +
           labs( title = 'Length of stay in days by hospital model and site\n (outliers excluded)',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Hospital code',
                 y = 'Count') +
  guides(colour = "none", fill = "none", size = "none") +
  #guides(colour = guide_legend("Hospital\nModel"),
  #       fill = guide_legend("Hospital\nModel")) +
    theme_minimal(base_size = 12)

```

A table showing the median, and a range of quantiles for the length of stay is also helpful. This is presented in the same order as the items in Figure 2.

```{r LOS Table}

LOS <- HIPE %>%
    group_by(ModelF, HospCode) %>%
    summarise(Mean   = round(mean(rawlos, na.rm = TRUE),2),
              Q10    = quantile(rawlos, probs = 0.1),
              Q25    = quantile(rawlos, probs = 0.25),
              Median = quantile(rawlos, probs = 0.5),
              Q75    = quantile(rawlos, probs = 0.75),
              Q90    = quantile(rawlos, probs = 0.90)) %>%
    ungroup()

kbl(LOS,  booktabs = TRUE, longtable = TRUE,
    caption = "Length of Stay by Hospital Type and Site.")

rm(LOS)
```

Again there is substantial variation between and within hospital types.

## Deaths, and discharge outcomes

Another very important variable is deaths in hospital. While most patients are discharged alive (be that a return home, or a transfer to other care sites, including other acute hospitals), about 6% of those admitted, aged over 65, and staying for more than three days, did not survive.

The table gives the overall results, and the figure shows how this varied between hospitals, and hospital types

```{r Dead table}
Dead <- HIPE %>%
  group_by(Died) %>%
  summarise(N = n())

kbl(Dead,  booktabs = TRUE, longtable = FALSE,
    caption = "Discharged alive or dead.")

rm(Dead)
```


```{r Risk of death by hospital and hospital type, fig.cap= 'Risk of death (per person) by hospital model and site.', fig.dpi=1200, fig.height=5, fig.width=7}
Dead <- HIPE %>%
  select(ModelF, HospCode, Died) %>%
  group_by(ModelF, HospCode, Died) %>%
  summarise(N = n()) %>%
  pivot_wider(names_from = Died, values_from = N) %>%
  ungroup() %>%
  mutate(Dead = ifelse(is.na(Dead), 0, Dead)) %>%
  mutate(Admissions = Alive+Dead) %>%
  mutate(Risk = Dead/(Admissions))

ggplot(data=Dead,
       aes(x=HospCode, y = Risk, colour = ModelF)) +
           geom_point(aes(size = Admissions)) +
  scale_x_discrete(guide = guide_axis(angle = 90)) +
    facet_wrap(~ModelF, scales = 'free_x') +
           labs( title = 'Risk of death by hospital model and site\n (point size is number of Admissions)',
                 subtitle = 'HIPE data, aged 65 years or over, 3 or more days stay, acute hospitals only',
                 x = 'Hospital code',
                 y = 'Risk of death') +
  guides(colour = "none", fill = "none", size = "none") +
    theme_minimal(base_size = 12)

rm(Dead)
```

It is important to emphasise that these crude death rates cannot be used to measure hospital outcomes, and still less to engage in the dubious activity of preparing league tables. Having said that, the results are not very surprising, and reflect the different roles and patient populations of the hospitals involved.

## Hospital coding
```{r}
Coding_Summary <- HIPE %>% group_by(ModelCode,HospCode) %>% summarise(across(ProcCount:HadxCount, list(mean = mean, sd = sd)))
```
# Preliminary modelling

Quantifying this variability we can use a random effects regression model. This allows the analysis of the effects of hospital type and other variables (fixed effects) and the variability between individual hospitals (random effects). For this preliminary work, the national HIPE data set is used.

Our first set of models looks only at age and sex as predictors of length of stay.

```{r Regression}
#Random intercept models
Model0 <- lm(data=HIPE,
             rawlos ~ age + sex)

Model1 <- lmer(data=HIPE,
             rawlos ~ age + sex +
               (1 | ModelF))

Model2 <- lmer(data=HIPE,
             rawlos ~ age + sex +
               (1 | HospCode))

Model3 <- lmer(data=HIPE,
             rawlos ~ age + sex +
               (1 | HospCode) + (1| ModelF))

Model4 <- lmer(data=HIPE,
             rawlos ~ age + sex +
               (1 | ModelF) +
                (1 | ModelF:HospCode))


tab_model(Model4, Model3, Model2, Model1, Model0, show.p = FALSE)
```

Looking at these results, age and sex have, as expected, significant impacts on length of stay. Hospital model, and, within the five hospital models, individual hospitals, all impact on length of stay.

Taking this as our baseline model, the next step is to fit a range of additional variables, and see how these affect the model. Given the number of observations, these need to be considered carefully.

```{r Model 5 RE for DRG}

Model5 <- lmer(data=HIPE,
             rawlos ~ age + sex +
               (1 | ModelF) +
                (1 | ModelF:HospCode) +
                (1 + sex | drgv.8))

Model6 <- lmer(data=HIPE,
             rawlos ~ age + sex +
                (1 | HospCode) +
                (1 | drgv.8))

tab_model(Model4,Model5, Model6)

```

The DRG code, as one might expect, has a huge impact on the length of stay. Much of the variability associated with hospital type is subsumed into the variability from the DRGs.

```{r Model 6 to 8 test out scores}

Model6 <- lmer(data=HIPE,
             rawlos ~ age + sex + ScoreEl +
               (1 | ModelF) +
                (1 | ModelF:HospCode) +
                (1 | drgv.8))
tab_model(Model6,Model5)

Model7 <- lmer(data=HIPE,
             rawlos ~ age + sex + ScoreCh +
               (1 | ModelF) +
                (1 | ModelF:HospCode) +
                (1 | drgv.8))
tab_model(Model7,Model6, Model5)

Model8 <- lmer(data=HIPE,
             rawlos ~ age + sex + ScoreEl + ScoreCh +
               (1 | ModelF) +
                (1 | ModelF:HospCode) +
                (1 | drgv.8))
tab_model(Model8,Model7, Model6)

```

Either the Elixhauser score, or the Charlson score, is a significant predictor of length of stay, but adding both is superfluous, so we choose to use only the Elixhauser score, as it seems to be more closely linked to our outcome.

```{r Elixhauser score only}
Model9 <- lmer(data=HIPE,
             rawlos ~ age + sex + ScoreEl + Source +
               (1 | ModelF) +
                (1 | ModelF:HospCode) +
                (1 | drgv.8))
tab_model(Model9,Model6)

```

The source of admission is also important. Most are admitted from home, but those admitted from long-term care facilities have shorter lengths of stay, and those transferred from other hospitals have longer lengths of stay.

```{r Add season of admission}
Model10 <- lmer(data=HIPE,
             rawlos ~ age + sex + ScoreEl + Source + SeasonOfAdmission +
               (1 | ModelF) +
                (1 | ModelF:HospCode) +
                (1 | drgv.8))
tab_model(Model10,Model9)

```

Fitting the Season of Discharge (Winter or Other) makes a modest contribution to the length of stay, but it has been identified in other work, so it will be retained.

## Linear and non-linear models

These are linear models, with (in principle) unconstrained outputs. This is not quite true, as for example, negative lengths of stay do not occur, there is a long positive tail, and this data set is limited to those with a length of stay of at least three days. However, for our purposes, exploratory modelling these seem at least useful.

To examine deaths, where the outcome variable is binary, Alive or Dead, at the time of discharge, requires non-linear models, and the usual choice is a logistic model.

```{r glm model}

LogModel1 <- glmer(data=HIPE %>%
                     mutate(DiedL = Died == "Dead"),
             DiedL ~ age + sex + ScoreEl + Source + SeasonOfAdmission +
               (1 | ModelF) +
                (1 | ModelF:HospCode) +
                (1 | drgv.8),
             family = binomial,
             control = glmerControl(optimizer = "bobyqa"))

tab_model(LogModel1)
```

While the numerical values are wildly different, and they are odds ratios, the confidence intervals of the parameters, and the size of the random effects remain convincing, suggesting that a similar model will explain deaths quite well too.

# Interpretation

None of this is surprising. Age, gender, and diagnosis (here represented as DRG), are obvious predictors of good and bad outcomes. The hospitals have very different roles, and very different catchment areas, all of which are expected to be relevant to outcomes.

```{r Save the files}
saveRDS(HIPE, file = "data/Hipe.rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)
saveRDS(HIPE.Site, file = "data/Hipe.Site.rds",
        ascii = FALSE, version = NULL,
        compress = TRUE, refhook = NULL)
```

# Bibliography


