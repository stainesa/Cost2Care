---
title: "Chart review results"
author: "Anthony Staines"
date: "`r Sys.Date()`"
output:
  pdf_document: 
    toc: true
    fig_caption: true
    number_sections: true
    latex_engine: xelatex
  word_document: default
  html_document: default
editor_options:
  chunk_output_type: console
bibliography: references.bib
csl: vancouver.csl
---
# Introduction
The object of this file is to generate a graph of confidence intervals and prediction intervals for the point estimates of the rates of each of the complications of interest, namely Pneumonia, Urinary Tract Infection, Pressure Ulcer, Delirium and Failure to Maintain, from the Chart Review data.

Confidence intervals are estimates of the precision of the point estimates from the original data, while prediction intervals are estimates of the precision of future point estimates, in this case from another chart review, a similar set of cases, of similar sample size.

In many cases prediction intervals are more useful, but they are also more difficult to calculate, requiring significant extra computation. In this work, the confidence intervals are binomial confidence intervals, and the prediction intervals are Bayesian, ultimately based on the beta-binomial distribution. The priors chosen are uninformative, with alpha and beta both set to one.

## Setup

```{r setup, include=FALSE}
rm(list=ls())

library(tidyverse)
library(knitr)
library(kableExtra)
library(extraDistr)

knitr::opts_chunk$set(echo = FALSE, messages = FALSE)
```

## Load the chart review data

Load the data, select key variables, and shift to long form.

```{r Load data}

Cost2Care.HIPE <- readRDS(file = "data/Cost2Care.HIPE.Rds") %>%
    select(StudyID, PN, UTI, PU, DL, F2M) %>%
    pivot_longer(!StudyID, names_to = "Outcome",
                 values_to = "Count") %>%
    mutate(Count = case_match(Count, # Numeric version of Count
                              "No"  ~ 0,
                              "Yes" ~1))

```

Prepare a dataframe with Source, Cases, Total, Estimate

```{r}
Source = "Chart_review"

Chart <- Cost2Care.HIPE %>%
    mutate(Source = Source) %>%
    relocate(Source) %>%
    group_by(Source,Outcome) %>%
    summarise(Cases = sum(Count),
              Total = n(),
              .groups = "drop") %>%
    mutate(Estimate = Cases/Total)
```

# Confidence Intervals

Calculate confidence intervals for the point estimate of the prevalence of adverse events of each type.

```{r calculate CI}
CI <- Hmisc::binconf(Chart$Cases, Chart$Total, include.x = TRUE, include.n = TRUE) # Calculate default Wilson CI's - A. Agresti and B.A. Coull, Approximate is better than "exact" for interval estimation of binomial proportions, American Statistician, 52:119â€“126, 1998.

Chart <- Chart %>%
  cbind(as_tibble(CI)) %>%
  select(!(X:PointEst)) %>% #Glue the CI's into the tibble
  rename(CI_Lower = Lower, CI_Upper = Upper)

# Sort out nicely ordered factor levels for chart labels
Chart <- Chart %>%
  mutate(Outcome = 
           fct_relevel(Outcome,
                  "PN", "UTI", "PU", "DL", "F2M") ) %>%
  mutate(Outcomes = case_match(Outcome,
                      "PN" ~ "Pneumonia",
                      "UTI" ~ "UTI",
                      "PU" ~  "Pressure Ulcer",
                      "DL" ~  "Delirium",
                      "F2M" ~ "Failure to Maintain")) %>%
  mutate(Outcomes = 
           fct_relevel(Outcomes,
                  "Pneumonia", "UTI",
                  "Pressure Ulcer", "Delirium",
                  "Failure to Maintain") )
```

```{r Point estimates and 0.95 confidence intervals for each outcome in the chart review data, fig.cap= 'Point estimates and 95% confidence intervals for each outcome in the chart review data.', fig.dpi=1200, fig.height=5, fig.width=7}

CI_plot <- ggplot(data=Chart,
                  aes(x = Outcomes, y = Estimate)) +
  geom_point(colour = 'red', size = 4) +
  geom_errorbar(aes(ymin = CI_Lower, ymax = CI_Upper, width = 0.2)) +
  labs(title = "Point estimates and 95% CI for outcomes",
       subtitle = "People 65 + discharged from study hospital",
       y = "Estimate") +
  guides(colour = "none", fill = "none", size = "none") +
    theme_minimal(base_size = 12) +
  scale_y_continuous(limits = c(0,0.28), breaks = c(0,0.5,0.1,0.15,0.2,0.25))

CI_plot
```

# Prediction intervals

First we write a function to calculate the prediction intervals. This is based on the lucid explanation from https://stats.stackexchange.com/questions/255570/prediction-interval-for-binomial-random-variable

```{r Prediction intervals}

  PI <- function(Study_Population, Study_Events,
               Event_Names,
               Prediction_Population,
               alpha  = 1, beta = 1)
  {  
  JVEC  <- rep( seq( from = 0,
          to = Prediction_Population-1,
          by = 1),
          each = length(Study_Events))

  NAMES <- rep(Event_Names,
               times = length(JVEC) /
                 length(Event_Names ))

  PROBS <- pbbinom(q = JVEC,
                   size = Study_Population,
                   alpha = (alpha + Study_Events),
                   beta = (beta +
                          Study_Population - Study_Events),
                   lower.tail = TRUE) # reminder

  Result <- tibble(JVEC, NAMES, PROBS) %>%
    select(NAMES, JVEC, PROBS) %>%
    arrange(NAMES,JVEC,PROBS) %>%
    group_by(NAMES) %>%
    mutate(PI_Lower = max(which(PROBS <= 0.025))) %>%
    mutate(PI_Upper = min(which(PROBS >= 0.975))) %>%
    select(NAMES, PI_Lower, PI_Upper) %>%
    distinct()

  return((Result))
}

#function(Study_Population, Study_Events,
#               Event_Names,
#               Prediction_Population,
#               alpha  = 1, beta = 1)

Probs2 <- PI(Study_Population = 1000,
             Study_Events = Chart$Cases,
             Event_Names = Chart$Outcome,
             Prediction_Population = 1000,
             alpha = 1, beta = 1)

Chart <- Chart %>%
  mutate(m = Total) %>%
  mutate(alpha = 1) %>%
  mutate(beta = 1) %>%
  mutate(PI_Estimate = m * (alpha + Cases)/(alpha + beta + Total)) # Sanity check - very very close to frequentist estimate as expected

Chart <- Chart %>%
  left_join(Probs2, by = join_by(Outcome == NAMES)) %>%
  mutate(PI_Estimate = PI_Estimate/m) %>% # Sclae correctly
  mutate(PI_Lower = PI_Lower/m) %>%
  mutate(PI_Upper = PI_Upper/m)
  
```

## Graphs

```{r Point estimates and 0.95 prediction intervals for each outcome in the chart review data, fig.cap= 'Point estimates and 95% prediction intervals for each outcome in the chart review data.', fig.dpi=1200, fig.height=5, fig.width=7}

PI_plot <- ggplot(data=Chart,
                  aes(x = Outcomes, y = PI_Estimate)) +
  geom_point(colour = 'red', size = 4) +
  geom_errorbar(aes(ymin = PI_Lower, ymax = PI_Upper, width = 0.2)) +
  labs(title = "Point estimates and 95% PI for outcomes",
       subtitle = "People 65 + discharged from study hospital",
       y = "Estimate") +
  guides(colour = "none", fill = "none", size = "none") +
    theme_minimal(base_size = 12) +
  scale_y_continuous(limits = c(0,0.28), breaks = c(0,0.5,0.1,0.15,0.2,0.25))

#PI_plot
```

A first attempt at a response is to glue together two plots for confidence intervals and prediction intervals, but this is not wholly satisfactory.

```{r Point estimates and 0.95 prediction and confidence intervals for each outcome in the chart review data 1, fig.cap= 'Point estimates and 95% confidence and prediction intervals for each outcome in the chart review data.', fig.dpi=1200, fig.height=5, fig.width=7}

library(patchwork)

CI_plot = CI_plot +
  theme(plot.title=element_blank()) +
  theme(plot.subtitle=element_blank())

PI_plot = PI_plot +
  theme(plot.title=element_blank()) +
  theme(plot.subtitle=element_blank())

plot <- (CI_plot + PI_plot) +
  plot_layout(axes = "collect", axis_titles = "collect") +
  plot_annotation(
    title = "Comparing 95% Confidence Intervals and Prediction Intervals",
    subtitle = "People 65 + discharged from study hospital"
  )

plot
```

A better solution is to use pivot_longer and pivot_wider to put the data into a common format, and then graph that.We also save the file as "image/CI_and_PI_plot_Chart_Review.png".

```{r Point estimates and 0.95 prediction and confidence intervals for each outcome in the chart review data 2, fig.cap= 'Point estimates and 95% prediction intervals for each outcome in the chart review data.', fig.dpi=1200, fig.height=5, fig.width=7}

Chart <- Chart %>%
  rename(CI_Estimate = Estimate) %>%
  select(Source, Outcome, Outcomes, Cases, Total, m, alpha, beta, 
         CI_Lower, CI_Estimate, CI_Upper,
         PI_Lower, PI_Estimate, PI_Upper)

Chart <- Chart %>%
  pivot_longer(cols = CI_Lower:PI_Upper,
               names_to = c("Type", "Measure"),
               names_sep = "_")

Chart <- Chart %>%
  pivot_wider(#cols = Type:value,
              names_from = c("Measure"),
              values_from = "value")

Both_plot <- ggplot(data = Chart,
                    aes(x = Outcomes, y = Estimate,
                        ymin = Lower, ymax = Upper,
                        colour = Type)) +
  geom_point(aes(y = Estimate),
             size = 4) +
  geom_errorbar(data = Chart %>%
               filter(Type == "CI"),
               aes(ymin = Lower, ymax = Upper),
                   linewidth = 1, width = 0.3) +
  geom_errorbar(data = Chart %>%
               filter(Type == "PI"),
               aes(ymin = Lower, ymax = Upper),
                   linewidth = 0.8, width = 0.2) +
  labs(title = "95% Prediction and confidence intervals for each outcome") +
  theme_minimal()
  
Both_plot

ggsave("image/CI_and_PI_plot_Chart_Review.png",
       units = "in", dpi = 1200, height = 5, width = 7)
```

# Save the data.

The data are saved as "data/CI_and_PI_Chart_Review.Rds".

```{r Save Chart data}

saveRDS(Chart, "data/CI_and_PI_Chart_Review.Rds")

```
